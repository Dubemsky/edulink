{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>{{ hub }} - EduLink</title>
  <meta name="description" content="EduLink student hub room - collaborate with your teacher and classmates">
  <meta name="keywords" content="education, collaboration, student hub">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Vendor CSS Files -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/aos/aos.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link href="{% static 'vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Main CSS Files -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet">
  <link href="{% static 'css/hub_room.css' %}" rel="stylesheet">
  <link href="{% static 'css/private_message.css' %}" rel="stylesheet">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
</head>

<body class="index-page">
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
      <a href="{% url 'students_homepage' %}" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">EduLink</h1>
      </a>
      
      <h3 class="page-title">Chat Room: {{ hub }}</h3>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a data-bs-toggle="modal" data-bs-target="#analyticsModal" style="cursor: pointer;">
            <i class="bi bi-bar-chart-line"></i> Analytics
          </a></li>
          <li><a href="{% url 'students_homepage' %}" class="active">
            <i class="bi bi-house"></i> Dashboard
          </a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <!-- Chat Room Section -->
  <section>
    <div class="container">
      <div class="rounded-container">
        <div class="chat-room">
          <aside class="chat-section">
            <div class="chat-messages" id="chatMessages" aria-live="polite" role="log">
              {% if messages %}
                {% for message in messages %}
                  <div class="message-box 
                    {% if message.is_current_user %}current-user-message{% elif message.role == 'teacher' %}teacher-message{% else %}other-user-message{% endif %}"
                    data-message="{{ message.content|escapejs }}"
                    data-message-id="{{ message.message_id }}"
                    {% if message.is_poll %} onclick="openSidePanel('{{ message.content|escapejs }}', '{{ message.message_id }}')" {% endif %}
                  >
                    <span class="message-sender">
                      {% if message.is_current_user %}
                        Me
                      {% else %}
                        {{ message.sender }}
                      {% endif %}
                    </span>
        
                    {% if message.image_url %}
                    <div class="message-image">
                      <a href="{{ message.image_url }}" target="_blank">
                        <img src="{{ message.image_url }}" alt="Shared image">
                      </a> 
                    </div>
                    {% endif %}
        
                    {% if message.file_url %}
                    <div class="message-file">
                      <a href="{{ message.file_url }}" target="_blank">
                        <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="File">
                        <span>
                          {% if message.content and message.content != "my file" %}
                            {{ message.content }}
                          {% else %}
                            Download File
                          {% endif %}
                        </span>
                      </a>
                    </div>
                    {% endif %}
        
                    {% if message.video_url %}
                    <div class="message-video">
                      <video src="{{ message.video_url }}" controls></video>
                    </div>
                    {% endif %}
        
                    {% if message.content and message.content != message.image_url and not message.file_url and not message.is_poll %}
                    <div class="message-text">
                      {{ message.content|linebreaksbr }}
                    </div>
                    {% endif %}
        
                    {% if message.is_poll %}
                    <div class="message-poll">
                      <strong>{{ message.content }}</strong>
                      <form id="poll-form-{{ message.message_id }}" data-message-id="{{ message.message_id }}" data-room-id="{{message.room_id}}">
                        <ul>
                          {% for option in message.poll_options %}
                            <li>
                              <input type="radio" id="option-{{ message.message_id }}-{{ forloop.counter }}" name="poll-option-{{ message.message_id }}" value="{{ option.option }}">
                              <label for="option-{{ message.message_id }}-{{ forloop.counter }}">{{ option.option }}</label>
                              <span class="vote-count" id="vote-count-{{ message.message_id }}-{{ forloop.counter }}">{{ option.votes }}</span>
                            </li>
                          {% endfor %}
                        </ul>
                        <button type="button" class="poll-vote-button" id="poll-vote-{{ message.message_id }}" onclick="submitPollVote('{{ message.message_id }}', '{{message.room_id}}')">Vote</button>
                      </form>
                    </div>
                    {% endif %}
        
                    {% if message.top_reply_content != 'No replies yet.' and not message.is_poll %}
                    <div class="top-reply">
                      <div class="top-reply-content">
                        <strong>Top Reply:</strong> {{ message.top_reply_content }}
                      </div>
                      <div class="top-reply-votes">
                        <span class="upvote" title="Upvote"></span> {{ message.top_reply_upvotes }} 
                        | 
                        <span class="downvote" title="Downvote"></span> {{ message.top_reply_downvotes }}
                      </div>
                    </div>
                    {% elif not message.is_poll %}
                    <div class="top-reply no-reply">
                      <em>No replies yet.</em>
                    </div>
                    {% endif %}
        
                    <span class="message-time">{{ message.created_at }}</span>
                  </div>
                {% endfor %}
              {% else %}
                <p class="no-messages">No messages yet. Start a conversation!</p>
              {% endif %}
            </div>
                    
            <footer class="chat-input">
              <div class="input-group">
                <div style="position: relative; display: inline-block;">
                  <button type="button" id="attachFileButton" class="btn btn-light">
                    <i class="fa fa-plus"></i>
                  </button>
                
                  <div id="upload-menu" class="dropdown-menu">
                    <button class="dropdown-item" id="upload-file">
                      <i class="fa fa-paperclip"></i> Share File
                    </button>
                    <button class="dropdown-item" id="upload-video">
                      <i class="fa fa-video-camera"></i> Share Video
                    </button>
                  </div>
                </div>
          
                <input type="file" id="file-input" style="display: none;">
                <input type="file" id="videoInput" style="display: none;" accept="video/*">
          
                <input type="text" id="messageInput" placeholder="Type your message..." class="form-control">
                <div id="suggestionsBox" style="display: none;"></div>
                
                <button type="button" id="sendMessageButton" class="btn btn-primary">
                  <i class="fa fa-paper-plane"></i>
                </button>
              </div>
            </footer>
            
            <div id="fileMessageContainer" class="floating-message-box" style="display: none;">
              <textarea id="fileMessageInput" placeholder="Attach a message with your file..." rows="3"></textarea>
              <div class="button-group">
                <button id="cancelMessageButton">Cancel</button>
                <button id="sendAttachedMessageButton">Send</button>
              </div>
            </div>
          </aside>

          <!-- Right Sidebar -->
          <aside class="right-sidebar">
            <div class="user-head">
              <h3>Hub Resources</h3>
              <div class="tabs">
                <button class="tab-button active" id="membersBtn" data-tab="members">Members</button>
                <button class="tab-button" id="bookmarksBtn" data-tab="bookmarks">Bookmarks</button>
                <button class="tab-button" id="streamsBtn" data-tab="streams">Streams</button>
              </div>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content" id="members" style="display:block;">
              <h4>Members ({{ members|length }})</h4>
              <ul class="members-list">
                {% if members %}
                  {% for member in members %}
                    <li>{{ member }}</li>
                  {% endfor %}
                {% else %}
                  <li class="no-members">No members have joined this hub yet.</li>
                {% endif %}
              </ul>
            </div>
        
            <div class="tab-content" id="bookmarks">
              <h4>Bookmarks</h4>
              <ul class="bookmarks-list">
                {% if bookmarks %}
                  {% for bookmark in bookmarks %}
                    <div class="bookmark-item">
                      <button class="bookmark-button" onclick="openSidePanel('{{ bookmark.message }}', '{{ bookmark.question_id }}')">{{ bookmark.message }}</button>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="no-bookmarks">
                    No bookmarks available.
                  </div>
                {% endif %}
              </ul>
            </div>
        
            <div class="tab-content" id="streams">
              <h4>Streams</h4>
              <ul class="streams-list">
                {% if streams %}
                  {% for stream in streams %}
                    <li>{{ stream }}</li>
                  {% endfor %}
                {% else %}
                  <li class="no-streams">No streams available.</li>
                {% endif %}
              </ul>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </section>

  <!-- Side Panel for Message Replies -->
  <!-- Side Panel for Message Replies with Truncated Title -->
<div id="side-panel" class="side-panel">
    <!-- Header with Sorting Options and Fixed Bookmark Button -->
    <div class="side-panel-header">
      <div class="header-content">
        <h2 id="panel-title" title="Full message will appear on hover">Message Title</h2>
        <div class="reply-sort-options">
          <button class="sort-button active" data-sort="recent">Recent</button>
          <button class="sort-button" data-sort="top">Top</button>
          <button class="sort-buttons" id="summariseButton">Summarise</button>
        </div>
      </div>
      <div class="bookmark-container">
        <button id="bookmark-button" class="bookmark-button circle">
          <i class="fa fa-bookmark"></i>
        </button>
      </div>
    </div>
  
    <!-- Messages Container -->
    <div class="side-panel-messages" id="sidePanelMessages">
      <!-- Dynamic content will be loaded here -->
    </div>
  
    <!-- Input Area -->
    <div class="side-panel-input">
      <input type="text" id="sidePanelInput" placeholder="Type your reply..." class="form-control">
      <button type="button" id="sidePanelSendButton"><i class="fa fa-paper-plane"></i></button>
    </div>
  </div>



  <!-- Analytics Modal -->
  <div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg analytics-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="analyticsModalLabel">Room Analytics: {{ hub }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Loading spinner -->
          <div class="spinner-container" id="analyticsSpinner">
            <div class="analytics-spinner"></div>
          </div>
          
          <!-- Analytics content (hidden initially) -->
          <div id="analyticsContent" style="display: none;">
            <!-- Analytics Tabs -->
            <div class="analytics-tabs">
              <div class="analytics-tab active" data-tab="overview">Overview</div>
              <div class="analytics-tab" data-tab="engagement">User Engagement</div>
              <div class="analytics-tab" data-tab="activity">Activity Timeline</div>
              <div class="analytics-tab" data-tab="polls">Poll Results</div>
            </div>
            
            <!-- Overview Tab -->
            <div class="analytics-tab-content active" id="overview-tab">
              <div class="row">
                <div class="col-md-3">
                  <div class="analytics-stat">
                    <div class="stat-value" id="total-messages">0</div>
                    <div class="stat-label">Total Messages</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="analytics-stat">
                    <div class="stat-value" id="total-replies">0</div>
                    <div class="stat-label">Total Replies</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="analytics-stat">
                    <div class="stat-value" id="total-participants">0</div>
                    <div class="stat-label">Participants</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="analytics-stat">
                    <div class="stat-value" id="total-reactions">0</div>
                    <div class="stat-label">Total Reactions</div>
                  </div>
                </div>
              </div>
              
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h5>Message Types</h5>
                </div>
                <div class="analytics-card-body">
                  <div class="chart-container">
                    <canvas id="messageTypesChart"></canvas>
                  </div>
                  <div id="message-types-legend" class="text-center mt-3"></div>
                </div>
              </div>
            </div>
            
            <!-- Remaining analytics tabs content -->
            <!-- User Engagement Tab -->
            <div class="analytics-tab-content" id="engagement-tab">
              <!-- Content will be populated by JavaScript -->
            </div>
            
            <!-- Activity Timeline Tab -->
            <div class="analytics-tab-content" id="activity-tab">
              <!-- Content will be populated by JavaScript -->
            </div>
            
            <!-- Poll Results Tab -->
            <div class="analytics-tab-content" id="polls-tab">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add CSRF token -->
  <script>
    document.cookie = "csrftoken={{ csrf_token }}";
  </script>

  <!-- Vendor JS Files -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/aos/aos.js' %}"></script>
  <script src="{% static 'vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'vendor/swiper/swiper-bundle.min.js' %}"></script>

  <!-- Main JS Files -->
  
  <script src="{% static 'js/main.js' %}"></script>
  <script src="{% static 'js/summarize.js' %}"></script>

  <script>




















    // Student-specific analytics module
// Enhanced Student Analytics Module with Tabs
const StudentAnalytics = (function() {
    // Private properties
    let analyticsData = null;
    let charts = {};
    
    // Cache DOM elements
    const $modal = document.getElementById('analyticsModal');
    const $spinner = document.getElementById('analyticsSpinner');
    const $content = document.getElementById('analyticsContent');
    
    // Initialize the module
    function init(roomId, username) {
        // Add event listener to modal
        if ($modal) {
            $modal.addEventListener('shown.bs.modal', function() {
                // Update modal title to indicate these are student's analytics
                const modalTitle = document.getElementById('analyticsModalLabel');
                if (modalTitle) {
                    const hubName = modalTitle.textContent.split('Room Analytics:')[1] || '';
                    modalTitle.textContent = `My Analytics${hubName}`;
                }
                
                // Fetch student-specific analytics when modal is opened
                fetchStudentAnalytics(roomId, username);
            });
            
            $modal.addEventListener('hidden.bs.modal', function() {
                // Destroy charts to prevent memory leaks
                Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                charts = {};
            });
        }
    }
    
    // Fetch student analytics data from the server
    function fetchStudentAnalytics(roomId, username) {
        showLoading();
        
        fetch(`/student-analytics/${roomId}/?username=${encodeURIComponent(username)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    analyticsData = data.analytics;
                    setupTabsAndRender();
                } else {
                    showError(data.error || 'Failed to load analytics');
                }
            })
            .catch(error => {
                console.error('Error fetching student analytics:', error);
                showError('Network error while loading analytics');
            })
            .finally(() => {
                hideLoading();
            });
    }
    
    // Show loading spinner
    function showLoading() {
        if ($spinner) $spinner.style.display = 'flex';
        if ($content) $content.style.display = 'none';
    }
    
    // Hide loading spinner
    function hideLoading() {
        if ($spinner) $spinner.style.display = 'none';
        if ($content) $content.style.display = 'block';
    }
    
    // Show error message
    function showError(message) {
        if ($content) {
            $content.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fa fa-exclamation-circle"></i> ${message}
                </div>
            `;
            $content.style.display = 'block';
        }
    }
    
    // Setup tabs and render content
    function setupTabsAndRender() {
        if (!analyticsData) return;
        
        try {
            // Set up the tabbed interface
            setupTabbedInterface();
            
            // Render each section in its appropriate tab
            renderOverviewDashboard();
            renderEngagementMetrics();
            renderContentAnalysis();
            renderSocialInteractions();
            renderLearningBehavior();
            renderProgressIndicators();
            renderActionableInsights();
            
            // Set up tab switching
            setupTabSwitching();
        } catch (error) {
            console.error('Error setting up tabs and rendering analytics:', error);
            showError('Error rendering analytics data');
        }
    }
    
    // Set up the tabbed interface
    function setupTabbedInterface() {
        if (!$content) return;

        // Define the tabs
        const tabs = [
            { id: 'overview', label: 'Overview', icon: 'fa-tachometer-alt' },
            { id: 'engagement', label: 'Engagement', icon: 'fa-users' },
            { id: 'content', label: 'Content', icon: 'fa-file-alt' },
            { id: 'social', label: 'Social', icon: 'fa-comments' },
            { id: 'learning', label: 'Learning', icon: 'fa-graduation-cap' },
            { id: 'progress', label: 'Progress', icon: 'fa-chart-line' },
            { id: 'insights', label: 'Insights', icon: 'fa-lightbulb' }
        ];
        
        // Create the tabbed interface container
        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'student-analytics-container';
        
        // Create the tab navigation
        const tabNav = document.createElement('div');
        tabNav.className = 'nav nav-tabs mb-4';
        tabNav.id = 'student-analytics-tabs';
        tabNav.setAttribute('role', 'tablist');
        
        // Create the tab content container
        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content';
        tabContent.id = 'student-analytics-tab-content';
        
        // Create each tab and its content pane
        tabs.forEach((tab, index) => {
            // Create the tab button
            const tabButton = document.createElement('button');
            tabButton.className = `nav-link ${index === 0 ? 'active' : ''}`;
            tabButton.id = `${tab.id}-tab`;
            tabButton.setAttribute('data-bs-toggle', 'tab');
            tabButton.setAttribute('data-bs-target', `#${tab.id}-pane`);
            tabButton.setAttribute('type', 'button');
            tabButton.setAttribute('role', 'tab');
            tabButton.setAttribute('aria-controls', `${tab.id}-pane`);
            tabButton.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
            tabButton.innerHTML = `<i class="fa ${tab.icon} me-2"></i>${tab.label}`;
            
            // Create the tab nav item
            const tabNavItem = document.createElement('div');
            tabNavItem.className = 'nav-item';
            tabNavItem.setAttribute('role', 'presentation');
            tabNavItem.appendChild(tabButton);
            
            tabNav.appendChild(tabNavItem);
            
            // Create the tab content pane
            const tabPane = document.createElement('div');
            tabPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
            tabPane.id = `${tab.id}-pane`;
            tabPane.setAttribute('role', 'tabpanel');
            tabPane.setAttribute('aria-labelledby', `${tab.id}-tab`);
            tabPane.setAttribute('tabindex', '0');
            
            tabContent.appendChild(tabPane);
        });
        
        // Add the tab navigation and content to the container
        tabsContainer.appendChild(tabNav);
        tabsContainer.appendChild(tabContent);
        
        // Replace the content with the tabbed interface
        $content.innerHTML = '';
        $content.appendChild(tabsContainer);
    }
    
    // Set up tab switching
    function setupTabSwitching() {
        // Use Bootstrap's tab functionality if available
        if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
                new bootstrap.Tab(button);
            });
        } else {
            // Manual tab switching if Bootstrap is not available
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get the target tab
                    const target = this.getAttribute('data-bs-target');
                    
                    // Deactivate all tabs
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    });
                    
                    // Hide all tab panes
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Activate the clicked tab
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    
                    // Show the target tab pane
                    const targetPane = document.querySelector(target);
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                });
            });
        }
    }
    
    // Render overview dashboard
    function renderOverviewDashboard() {
        const overviewPane = document.getElementById('overview-pane');
        if (!overviewPane || !analyticsData) return;
        
        
        
        console.log("I am here now ")
        const engagement = analyticsData.personal_engagement;
        const social = analyticsData.social_interaction;
        const learning = analyticsData.learning_behavior;
        
        // Create dashboard container
        const dashboard = document.createElement('div');
        dashboard.className = 'overview-dashboard';
        
        // Create stats grid
        const statsGrid = document.createElement('div');
        statsGrid.className = 'row';
        
        // Key stats
        const keyStats = [
            { 
                label: 'Contributions', 
                value: engagement.total_contributions,
                icon: 'fa-comment-dots',
                color: 'primary'
            },
            { 
                label: 'Participation', 
                value: engagement.participation_percentage.toFixed(1) + '%',
                icon: 'fa-users',
                color: 'success'
            },
            { 
                label: 'Active Days', 
                value: engagement.active_days,
                icon: 'fa-calendar-check',
                color: 'info'
            },
            { 
                label: 'Net Score', 
                value: social.net_contribution_score,
                icon: 'fa-star',
                color: 'warning'
            },
            { 
                label: 'Bookmarks', 
                value: learning.bookmarks_count,
                icon: 'fa-bookmark',
                color: 'danger'
            },
            { 
                label: 'Poll Votes', 
                value: learning.poll_votes_count,
                icon: 'fa-poll',
                color: 'secondary'
            }
        ];
        
        // Add each stat card
        keyStats.forEach(stat => {
            const statCard = document.createElement('div');
            statCard.className = 'col-md-4 mb-4';
            statCard.innerHTML = `
                <div class="card border-${stat.color} shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-${stat.color} p-3 me-3">
                                <i class="fa ${stat.icon} text-white"></i>
                            </div>
                            <div>
                                <div class="stat-value h4 mb-0">${stat.value}</div>
                                <div class="stat-label text-muted">${stat.label}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            statsGrid.appendChild(statCard);
        });
        
        dashboard.appendChild(statsGrid);
        
        // Add performance summary
        const summaryCard = document.createElement('div');
        summaryCard.className = 'card mt-4 mb-4';
        
        // Create progress bars for key metrics
        const progressBars = [
            {
                label: 'Participation Rate',
                value: engagement.participation_percentage,
                max: 100,
                color: getProgressColor(engagement.participation_percentage, 5, 15, 30)
            },
            {
                label: 'Poll Participation',
                value: learning.poll_participation_rate,
                max: 100,
                color: getProgressColor(learning.poll_participation_rate, 25, 50, 75)
            },
            {
                label: 'Consistency Score',
                value: analyticsData.progress_indicators.consistency_score,
                max: 100,
                color: getProgressColor(analyticsData.progress_indicators.consistency_score, 30, 60, 80)
            },
            {
                label: 'Teacher Interaction',
                value: social.teacher_interaction_rate,
                max: 100,
                color: getProgressColor(social.teacher_interaction_rate, 10, 30, 50)
            }
        ];
        
        let progressHtml = '';
        progressBars.forEach(bar => {
            progressHtml += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>${bar.label}</span>
                        <span>${bar.value.toFixed(1)}%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-${bar.color}" role="progressbar" style="width: ${Math.min(bar.value, 100)}%"></div>
                    </div>
                </div>
            `;
        });
        
        summaryCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Performance Summary</h5>
            </div>
            <div class="card-body">
                ${progressHtml}
            </div>
        `;
        
        dashboard.appendChild(summaryCard);
        
        // Add the dashboard to the overview pane
        overviewPane.appendChild(dashboard);
    }
    
    // Helper function to get progress bar color
    function getProgressColor(value, lowThreshold, mediumThreshold, highThreshold) {
        if (value < lowThreshold) return 'danger';
        if (value < mediumThreshold) return 'warning';
        if (value < highThreshold) return 'info';
        return 'success';
    }
    
    // Render engagement metrics
    function renderEngagementMetrics() {
        const engagementPane = document.getElementById('engagement-pane');
        if (!engagementPane || !analyticsData) return;
        
        const engagement = analyticsData.personal_engagement;
        
        // Create engagement metrics container
        const container = document.createElement('div');
        
        // Basic stats row
        const statsRow = document.createElement('div');
        statsRow.className = 'row mb-4';
        
        // Messages sent card
        const messagesCard = document.createElement('div');
        messagesCard.className = 'col-md-4';
        messagesCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h1 class="display-4">${engagement.messages_sent}</h1>
                    <p class="text-muted">Messages Sent</p>
                </div>
            </div>
        `;
        statsRow.appendChild(messagesCard);
        
        // Replies sent card
        const repliesCard = document.createElement('div');
        repliesCard.className = 'col-md-4';
        repliesCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h1 class="display-4">${engagement.replies_sent}</h1>
                    <p class="text-muted">Replies Sent</p>
                </div>
            </div>
        `;
        statsRow.appendChild(repliesCard);
        
        // Message/Reply ratio card
        const ratioCard = document.createElement('div');
        ratioCard.className = 'col-md-4';
        ratioCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h1 class="display-4">${engagement.message_reply_ratio.toFixed(1)}</h1>
                    <p class="text-muted">Message/Reply Ratio</p>
                </div>
            </div>
        `;
        statsRow.appendChild(ratioCard);
        
        container.appendChild(statsRow);
        
        // Active times chart
        const activeTimesCard = document.createElement('div');
        activeTimesCard.className = 'card mb-4';
        activeTimesCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Most Active Times</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="activeTimesChart"></canvas>
                </div>
            </div>
        `;
        container.appendChild(activeTimesCard);
        
        // Add the container to the engagement pane
        engagementPane.appendChild(container);
        
        // Render the active times chart
        renderActiveTimesChart(engagement.active_times);
    }
    
    // Helper function to render active times chart
    function renderActiveTimesChart(activeTimes) {
        const canvas = document.getElementById('activeTimesChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Prepare data for 24-hour chart
        const hours = Array.from({ length: 24 }, (_, i) => i);
        const activityData = Array(24).fill(0);
        
        // Fill in the activity data
        activeTimes.forEach(item => {
            activityData[item.hour] = item.count;
        });
        
        // Format hours for display (12-hour format with AM/PM)
        const hourLabels = hours.map(hour => {
            const period = hour < 12 ? 'AM' : 'PM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}${period}`;
        });
        
        // Create the chart
        charts.activeTimes = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [{
                    label: 'Activity',
                    data: activityData,
                    backgroundColor: '#4e73df',
                    borderColor: '#4e73df',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Messages'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                }
            }
        });
    }
    
    // Render content analysis
    function renderContentAnalysis() {
        const contentPane = document.getElementById('content-pane');
        if (!contentPane || !analyticsData) return;
        
        const content = analyticsData.content_analytics;
        
        // Create content analysis container
        const container = document.createElement('div');
        
        // Message types chart card
        const messageTypesCard = document.createElement('div');
        messageTypesCard.className = 'card mb-4';
        messageTypesCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Message Types</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="messageTypesChart"></canvas>
                </div>
            </div>
        `;
        container.appendChild(messageTypesCard);
        
        // Other content metrics card
        const contentMetricsCard = document.createElement('div');
        contentMetricsCard.className = 'card';
        contentMetricsCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Content Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-item mb-3">
                            <h5>Average Message Length</h5>
                            <p class="h3">${content.avg_message_length.toFixed(1)} characters</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-item mb-3">
                            <h5>Question Rate</h5>
                            <p class="h3">${content.question_rate.toFixed(1)}%</p>
                            <small class="text-muted">Percentage of messages containing questions</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(contentMetricsCard);
        
        // Add the container to the content pane
        contentPane.appendChild(container);
        
        // Render the message types chart
        renderMessageTypesChart(content.message_types);
    }
    
    // Helper function to render message types chart
    function renderMessageTypesChart(messageTypes) {
        const canvas = document.getElementById('messageTypesChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Define colors for message types
        const typeColors = {
            'text': '#4e73df',
            'image': '#1cc88a',
            'file': '#f6c23e',
            'video': '#fd7e14',
            'poll': '#36b9cc'
        };
        
        // Format data for the chart
        const labels = Object.keys(messageTypes);
        const data = Object.values(messageTypes);
        const backgroundColor = labels.map(label => typeColors[label] || '#858796');
        
        // Create the chart
        charts.messageTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColor,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Render social interactions
    function renderSocialInteractions() {
        const socialPane = document.getElementById('social-pane');
        if (!socialPane || !analyticsData) return;
        
        const social = analyticsData.social_interaction;
        
        // Create social interactions container
        const container = document.createElement('div');
        
        // Reactions stats row
        const reactionsRow = document.createElement('div');
        reactionsRow.className = 'row mb-4';
        
        // Upvotes received card
        const upvotesCard = document.createElement('div');
        upvotesCard.className = 'col-md-3';
        upvotesCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1 text-success">${social.upvotes_received}</h2>
                    <p class="text-muted">Upvotes Received</p>
                </div>
            </div>
        `;
        reactionsRow.appendChild(upvotesCard);
        
        // Downvotes received card
        const downvotesCard = document.createElement('div');
        downvotesCard.className = 'col-md-3';
        downvotesCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1 text-danger">${social.downvotes_received}</h2>
                    <p class="text-muted">Downvotes Received</p>
                </div>
            </div>
        `;
        reactionsRow.appendChild(downvotesCard);
        
        // Net score card
        const netScoreCard = document.createElement('div');
        netScoreCard.className = 'col-md-3';
        netScoreCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1 ${social.net_contribution_score >= 0 ? 'text-success' : 'text-danger'}">${social.net_contribution_score}</h2>
                    <p class="text-muted">Net Score</p>
                </div>
            </div>
        `;
        reactionsRow.appendChild(netScoreCard);
        
        // Response rate card
        const responseRateCard = document.createElement('div');
        responseRateCard.className = 'col-md-3';
        responseRateCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1">${social.response_rate.toFixed(1)}%</h2>
                    <p class="text-muted">Response Rate</p>
                </div>
            </div>
        `;
        reactionsRow.appendChild(responseRateCard);
        
        container.appendChild(reactionsRow);
        
        // Voting charts card
        const votingCard = document.createElement('div');
        votingCard.className = 'card mb-4';
        votingCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Voting Activity</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-center">Votes Given</h6>
                        <div style="height: 200px;">
                            <canvas id="votesGivenChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-center">Votes Received</h6>
                        <div style="height: 200px;">
                            <canvas id="votesReceivedChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(votingCard);
        
        // Add the container to the social pane
        socialPane.appendChild(container);
        
        // Render the voting charts
        renderVotingCharts(social);
    }
    
    // Helper function to render voting charts
    function renderVotingCharts(social) {
        // Render votes given chart
        const votesGivenCanvas = document.getElementById('votesGivenChart');
        if (votesGivenCanvas) {
            const ctx = votesGivenCanvas.getContext('2d');
            
            charts.votesGiven = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Upvotes', 'Downvotes'],
                    datasets: [{
                        data: [social.upvotes_given, social.downvotes_given],
                        backgroundColor: ['#1cc88a', '#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Render votes received chart
        const votesReceivedCanvas = document.getElementById('votesReceivedChart');
        if (votesReceivedCanvas) {
            const ctx = votesReceivedCanvas.getContext('2d');
            
            charts.votesReceived = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Upvotes', 'Downvotes'],
                    datasets: [{
                        data: [social.upvotes_received, social.downvotes_received],
                        backgroundColor: ['#1cc88a', '#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }
    
    // Render learning behavior
    function renderLearningBehavior() {
        const learningPane = document.getElementById('learning-pane');
        if (!learningPane || !analyticsData) return;
        
        const learning = analyticsData.learning_behavior;
        
        // Create learning behavior container
        const container = document.createElement('div');
        
        // Learning stats row
        const learningRow = document.createElement('div');
        learningRow.className = 'row mb-4';
        
        // Bookmarks card
        const bookmarksCard = document.createElement('div');
        bookmarksCard.className = 'col-md-4';
        bookmarksCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1">${learning.bookmarks_count}</h2>
                    <p class="text-muted">Bookmarks</p>
                </div>
            </div>
        `;
        learningRow.appendChild(bookmarksCard);
        
        // Poll votes card
        const pollVotesCard = document.createElement('div');
        pollVotesCard.className = 'col-md-4';
        pollVotesCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1">${learning.poll_votes_count}</h2>
                    <p class="text-muted">Poll Votes</p>
                </div>
            </div>
        `;
        learningRow.appendChild(pollVotesCard);
        
        // Resource engagement card
        const resourceCard = document.createElement('div');
        resourceCard.className = 'col-md-4';
        resourceCard.innerHTML = `
            <div class="card h-100">
                <div class="card-body text-center">
                    <h2 class="h1">${learning.resource_engagement}</h2>
                    <p class="text-muted">Resources Shared</p>
                </div>
            </div>
        `;
        learningRow.appendChild(resourceCard);
        
        container.appendChild(learningRow);
        
        // Learning behavior metrics card
        const metricsCard = document.createElement('div');
        metricsCard.className = 'card mb-4';
        metricsCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Learning Engagement</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-item mb-3">
                            <h5>Poll Participation Rate</h5>
                            <p class="h3">${learning.poll_participation_rate.toFixed(1)}%</p>
                            <small class="text-muted">Percentage of polls you've voted in</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-item mb-3">
                            <h5>Reading-Writing Ratio</h5>
                            <p class="h3">${learning.reading_writing_ratio.toFixed(1)}</p>
                            <small class="text-muted">Ratio of consuming vs creating content</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(metricsCard);
        
        // Add the container to the learning pane
        learningPane.appendChild(container);
    }
    
    // Render progress indicators
    function renderProgressIndicators() {
        const progressPane = document.getElementById('progress-pane');
        if (!progressPane || !analyticsData) return;
        
        const progress = analyticsData.progress_indicators;
        
        // Create progress indicators container
        const container = document.createElement('div');
        
        // Activity timeline chart
        const timelineCard = document.createElement('div');
        timelineCard.className = 'card mb-4';
        timelineCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Activity Timeline</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="activityTimelineChart"></canvas>
                </div>
            </div>
        `;
        container.appendChild(timelineCard);
        
        // Trend analysis card
        const trendCard = document.createElement('div');
        trendCard.className = 'card mb-4';
        
        // Determine trend icon and color
        let trendIcon, trendColor, trendDescription;
        if (progress.trend_analysis.trend === 'increasing') {
            trendIcon = 'fa-arrow-up';
            trendColor = 'success';
            trendDescription = 'Your activity is increasing over time';
        } else if (progress.trend_analysis.trend === 'decreasing') {
            trendIcon = 'fa-arrow-down';
            trendColor = 'danger';
            trendDescription = 'Your activity is decreasing over time';
        } else {
            trendIcon = 'fa-equals';
            trendColor = 'info';
            trendDescription = 'Your activity is stable over time';
        }
        
        trendCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Activity Trend</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-3 rounded-circle bg-${trendColor} text-white me-3">
                        <i class="fa ${trendIcon}"></i>
                    </div>
                    <div>
                        <h4>${trendDescription}</h4>
                        <p class="mb-0">
                            Your daily change rate is approximately 
                            <strong>${Math.abs(progress.trend_analysis.activity_change_rate).toFixed(2)}</strong> 
                            messages per day
                        </p>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(trendCard);
        
        // Consistency score card
        const consistencyCard = document.createElement('div');
        consistencyCard.className = 'card mb-4';
        consistencyCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Consistency</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Consistency Score</span>
                        <span>${progress.consistency_score.toFixed(1)}%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-${getProgressColor(progress.consistency_score, 30, 60, 80)}" 
                            role="progressbar" 
                            style="width: ${Math.min(progress.consistency_score, 100)}%">
                        </div>
                    </div>
                </div>
                <p class="text-muted">
                    This score measures how regularly you participate in the room.
                    ${progress.consistency_score < 30 ? 
                        'Try to engage more consistently to improve your learning experience.' : 
                        progress.consistency_score < 60 ? 
                        'You\'re participating somewhat regularly, but could be more consistent.' : 
                        'Great job maintaining regular participation in this room!'}
                </p>
            </div>
        `;
        container.appendChild(consistencyCard);
        
        // Top content card
        const topContentCard = document.createElement('div');
        topContentCard.className = 'card';
        
        // Generate top content HTML
        let topContentHtml = '';
        if (progress.top_content && progress.top_content.length > 0) {
            progress.top_content.forEach((content, index) => {
                // Format the content text
                const contentText = content.content || content.text;
                const formattedText = contentText && contentText.length > 100 ? 
                    contentText.substring(0, 100) + '...' : contentText;
                
                // Format the date if available
                let dateDisplay = '';
                if (content.timestamp) {
                    try {
                        const date = new Date(content.timestamp);
                        dateDisplay = `<span class="text-muted">${date.toLocaleDateString()}</span>`;
                    } catch (e) {
                        // Ignore date formatting errors
                    }
                }
                
                topContentHtml += `
                    <div class="top-content-item d-flex align-items-start mb-3 pb-3 ${index < progress.top_content.length - 1 ? 'border-bottom' : ''}">
                        <div class="me-3">
                            <span class="badge bg-${content.type === 'message' ? 'primary' : 'success'} px-2 py-1">
                                ${content.type}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <div>${formattedText || 'No content available'}</div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="text-${content.votes >= 0 ? 'success' : 'danger'}">
                                    <i class="fa fa-thumbs-${content.votes >= 0 ? 'up' : 'down'}"></i> ${Math.abs(content.votes)}
                                </span>
                                ${dateDisplay}
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            topContentHtml = `<p class="text-center py-3">No rated content available yet.</p>`;
        }
        
        topContentCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Your Top Content</h5>
            </div>
            <div class="card-body">
                ${topContentHtml}
            </div>
        `;
        container.appendChild(topContentCard);
        
        // Add the container to the progress pane
        progressPane.appendChild(container);
        
        // Render the activity timeline chart
        renderActivityTimelineChart(progress.activity_timeline);
    }
    
    // Helper function to render activity timeline chart
    function renderActivityTimelineChart(timelineData) {
        const canvas = document.getElementById('activityTimelineChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Format the dates and counts for the chart
        const dates = [];
        const counts = [];
        
        timelineData.forEach(item => {
            dates.push(item.date);
            counts.push(item.count);
        });
        
        // Create the chart
        charts.activityTimeline = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Number of Messages',
                    data: counts,
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    borderColor: '#4e73df',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: '#4e73df',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#5a5c69',
                        bodyColor: '#858796',
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        xPadding: 15,
                        yPadding: 15,
                        displayColors: false,
                        caretPadding: 10,
                        callbacks: {
                            label: function(context) {
                                return `Messages: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Render actionable insights
    function renderActionableInsights() {
        const insightsPane = document.getElementById('insights-pane');
        if (!insightsPane || !analyticsData) return;
        
        const insights = analyticsData.actionable_insights;
        
        // Create insights container
        const container = document.createElement('div');
        
        // Header card with explanation
        const headerCard = document.createElement('div');
        headerCard.className = 'card mb-4';
        headerCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Personalized Insights</h5>
            </div>
            <div class="card-body">
                <p>Based on your activity patterns, here are some insights and recommendations to help you get the most out of this room:</p>
            </div>
        `;
        container.appendChild(headerCard);
        
        // If there are insights, display them
        if (insights && insights.length > 0) {
            // Group insights by importance
            const highImportance = insights.filter(insight => insight.importance === 'high');
            const mediumImportance = insights.filter(insight => insight.importance === 'medium');
            const lowImportance = insights.filter(insight => insight.importance === 'low');
            
            // Create a card for each importance level that has insights
            
            // High importance insights
            if (highImportance.length > 0) {
                const highCard = document.createElement('div');
                highCard.className = 'card mb-4 border-danger';
                
                let highInsightsHtml = '';
                highImportance.forEach(insight => {
                    highInsightsHtml += `
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-circle me-2"></i>
                            ${insight.message}
                        </div>
                    `;
                });
                
                highCard.innerHTML = `
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">High Priority</h5>
                    </div>
                    <div class="card-body">
                        ${highInsightsHtml}
                    </div>
                `;
                container.appendChild(highCard);
            }
            
            // Medium importance insights
            if (mediumImportance.length > 0) {
                const mediumCard = document.createElement('div');
                mediumCard.className = 'card mb-4 border-warning';
                
                let mediumInsightsHtml = '';
                mediumImportance.forEach(insight => {
                    mediumInsightsHtml += `
                        <div class="alert alert-warning">
                            <i class="fa fa-info-circle me-2"></i>
                            ${insight.message}
                        </div>
                    `;
                });
                
                mediumCard.innerHTML = `
                    <div class="card-header bg-warning">
                        <h5 class="card-title mb-0">Suggestions</h5>
                    </div>
                    <div class="card-body">
                        ${mediumInsightsHtml}
                    </div>
                `;
                container.appendChild(mediumCard);
            }
            
            // Low importance insights
            if (lowImportance.length > 0) {
                const lowCard = document.createElement('div');
                lowCard.className = 'card mb-4 border-info';
                
                let lowInsightsHtml = '';
                lowImportance.forEach(insight => {
                    lowInsightsHtml += `
                        <div class="alert alert-info">
                            <i class="fa fa-lightbulb me-2"></i>
                            ${insight.message}
                        </div>
                    `;
                });
                
                lowCard.innerHTML = `
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Tips</h5>
                    </div>
                    <div class="card-body">
                        ${lowInsightsHtml}
                    </div>
                `;
                container.appendChild(lowCard);
            }
        } else {
            // No insights available
            const noInsightsCard = document.createElement('div');
            noInsightsCard.className = 'card';
            noInsightsCard.innerHTML = `
                <div class="card-body text-center py-5">
                    <i class="fa fa-check-circle text-success fa-3x mb-3"></i>
                    <h4>No specific recommendations at this time</h4>
                    <p class="text-muted">Keep up the good work! As you continue to participate, we'll provide personalized insights.</p>
                </div>
            `;
            container.appendChild(noInsightsCard);
        }
        
        // Add general tips card
        const tipsCard = document.createElement('div');
        tipsCard.className = 'card mt-4';
        tipsCard.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">General Tips for Success</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Engage regularly with discussions
                            </li>
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Ask questions when you're unsure
                            </li>
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Provide thoughtful responses to others
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Bookmark important content for later review
                            </li>
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Participate in polls to share your perspective
                            </li>
                            <li class="list-group-item">
                                <i class="fa fa-check text-success me-2"></i>
                                Share resources that might help your peers
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(tipsCard);
        
        // Add the container to the insights pane
        insightsPane.appendChild(container);
    }
    
    // Public API
    return {
        init: init,
        fetchStudentAnalytics: fetchStudentAnalytics
    };
})();

// Initialize the student analytics when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get room ID and username from the page
    const roomId = "{{ room_id|escapejs }}";
    const username = "{{ current_student_name|escapejs }}";
   console.log("I am here")

    
    if (roomId && username) {

        console.log("This is me here with ", currentUserName)
        // Initialize the student analytics module
        StudentAnalytics.init(roomId, username);
        
        // Add some basic styles to ensure proper display
        const style = document.createElement('style');
        style.textContent = `
            .student-analytics-container .nav-tabs {
                border-bottom: 1px solid #dee2e6;
            }
            .student-analytics-container .nav-link {
                margin-bottom: -1px;
                border: 1px solid transparent;
                border-top-left-radius: 0.25rem;
                border-top-right-radius: 0.25rem;
            }
            .student-analytics-container .nav-link:hover, 
            .student-analytics-container .nav-link:focus {
                border-color: #e9ecef #e9ecef #dee2e6;
            }
            .student-analytics-container .nav-link.active {
                color: #495057;
                background-color: #fff;
                border-color: #dee2e6 #dee2e6 #fff;
            }
            .student-analytics-container .tab-content {
                padding-top: 20px;
            }
            .student-analytics-container .tab-pane {
                display: none;
            }
            .student-analytics-container .tab-pane.active {
                display: block;
            }
            .student-analytics-container .tab-pane.show {
                opacity: 1;
            }
            .student-analytics-container .card {
                box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            }
        `;
        document.head.appendChild(style);
    } else {
        console.error('Room ID or username not found. Student analytics cannot be initialized.');
    }
});
    
    
    
    
        
    const currentRoomId = "{{ room_id|escapejs }}";
    const currentUserName = "{{ current_student_name|escapejs }}";
    // Add CSS for toast notifications
    document.head.insertAdjacentHTML('beforeend', `
    <style>
    #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
    }
    </style>
    `);
    
    
    
    
    // User's poll votes storage
    const userPollVotes = {}; // Format: { pollId: selectedOption }
    
    // Function to submit a poll vote
    function submitPollVote(messageId, roomId) {
        const form = document.getElementById(`poll-form-${messageId}`);
        const selectedOption = form.querySelector(`input[name="poll-option-${messageId}"]:checked`);
        const voteButton = document.getElementById(`poll-vote-${messageId}`);
        
        // If user has already voted for this poll
        if (userPollVotes[messageId]) {
            showToast("You've already voted in this poll", "info");
            return;
        }
        
        if (!selectedOption) {
            showToast("Please select an option", "error");
            return;
        }
        
        const selectedValue = selectedOption.value;
        
        // Disable the vote button during submission
        voteButton.disabled = true;
        voteButton.textContent = "Voting...";
        
        fetch("/poll-voting/", { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
                message_id: messageId,
                room_id: roomId,
                selected_option: selectedValue,
                username: currentUserName
            }),
        })
        .then(response => response.json())
        .then(data => {
            voteButton.disabled = false;
            voteButton.textContent = "Vote";
            
            if (data.success) {
                // Update the vote counts in the UI
                data.poll_options.forEach((option, index) => {
                    const voteCountElement = document.getElementById(`vote-count-${messageId}-${index + 1}`);
                    if (voteCountElement) {
                        voteCountElement.textContent = option.votes;
                    }
                });
                
                // Store the user's vote
                userPollVotes[messageId] = selectedValue;
                
                // Change the UI to show the user has voted
                markPollAsVoted(messageId, selectedValue);
                
                showToast("Vote submitted successfully", "success");
            } else {
                if (data.error === "already_voted") {
                    showToast("You've already voted in this poll", "info");
                    
                    // Update the UI to reflect the user's previous vote
                    if (data.user_vote) {
                        userPollVotes[messageId] = data.user_vote;
                        markPollAsVoted(messageId, data.user_vote);
                    }
                } else {
                    showToast("Failed to submit vote", "error");
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            voteButton.disabled = false;
            voteButton.textContent = "Vote";
            showToast("An error occurred", "error");
        });
    }
    
    // Function to mark a poll as voted for this user
    function markPollAsVoted(messageId, selectedValue) {
        const form = document.getElementById(`poll-form-${messageId}`);
        const voteButton = document.getElementById(`poll-vote-${messageId}`);
        const radioButtons = form.querySelectorAll(`input[type="radio"]`);
        
        // Disable all radio buttons
        radioButtons.forEach(radio => {
            radio.disabled = true;
            
            // Highlight the user's choice
            if (radio.value === selectedValue) {
                radio.checked = true;
                radio.parentElement.classList.add('user-voted');
            }
        });
        
        // Change the vote button to show "Voted"
        voteButton.textContent = "Voted";
        voteButton.disabled = true;
        voteButton.classList.add('voted');
        
        // Add a class to the form to show it's been voted on
        form.classList.add('voted');
    }
    
    // Function to check user's poll votes when loading the page
    function checkUserPollVotes() {
        // Get all poll IDs on the page
        const pollForms = document.querySelectorAll('form[id^="poll-form-"]');
        const pollIds = Array.from(pollForms).map(form => form.dataset.messageId);
        
        if (pollIds.length === 0) return;
        
        fetch("/check-poll-votes/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                username: currentUserName,
                poll_ids: pollIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.votes) {
                // Update userPollVotes and UI for each poll
                Object.entries(data.votes).forEach(([pollId, voteInfo]) => {
                    userPollVotes[pollId] = voteInfo.option;
                    markPollAsVoted(pollId, voteInfo.option);
                });
            }
        })
        .catch(error => {
            console.error('Error checking poll votes:', error);
        });
    }
    
    // Add CSS for voted polls
    const pollStyles = `
    .poll-vote-button.voted {
        background-color: #4CAF50;
        cursor: default;
    }
    
    form.voted .pollOptionInput {
        opacity: 0.7;
    }
    
    li.user-voted {
        background-color: rgba(76, 175, 80, 0.1);
        border-radius: 4px;
        padding: 4px;
    }
    
    .poll-results-bar {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        margin-top: 4px;
        position: relative;
        overflow: hidden;
    }
    
    .poll-results-fill {
        height: 100%;
        background-color: #2196F3;
        border-radius: 5px;
        transition: width 0.5s ease-in-out;
    }
    
    .poll-option-votes {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2px;
    }
    
    .poll-option-text {
        flex-grow: 1;
        margin-right: 10px;
    }
    
    .poll-option-count {
        font-weight: bold;
        min-width: 30px;
        text-align: right;
    }
    `;
    
    // Add the styles to the head
    document.head.insertAdjacentHTML('beforeend', `<style>${pollStyles}</style>`);
    
    // Call this function when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Check user's poll votes
        checkUserPollVotes();
    });
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    document.addEventListener('DOMContentLoaded', function () {
        // Access the roomId passed from Django context
        const roomId = "{{ room_id|escapejs }}";  // Ensure the roomId is properly passed from Django context
    
        // Set up a timeout for debouncing the input
        let debounceTimeout;
    
        // Listen for input event in the message input field
        document.getElementById('messageInput').addEventListener('input', async (event) => {
            const query = event.target.value.trim();
    
            // Log the query to check what the user is typing
            console.log("User input:", query);
    
            // Clear the previous timeout to implement debouncing
            clearTimeout(debounceTimeout);
    
            if (query.length > 0) {
                // Show the suggestion box when the user types
                document.getElementById('suggestionsBox').style.display = 'block';
    
                // Set a timeout to make the request after the user stops typing for 300ms
                debounceTimeout = setTimeout(async () => {
                    try {
                        console.log("Making request with query:", query, "and roomId:", roomId);
    
                        // Call the backend to get similar questions based on roomId and query
                        const response = await fetch(`/get_suggestions/?query=${encodeURIComponent(query)}&room_id=${encodeURIComponent(roomId)}`);
    
                        if (response.ok) {
                            const suggestions = await response.json();
                            console.log("Suggestions received:", suggestions);  // Log the suggestions received from the server
                            showSuggestions(suggestions);
                        } else {
                            console.error('Failed to fetch suggestions:', response.status);
                            document.getElementById('suggestionsBox').style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error fetching suggestions:', error);
                        document.getElementById('suggestionsBox').style.display = 'none';
                    }
                }, 300); // 300ms debounce time
            } else {
                // Hide the suggestion box when the input is empty
                document.getElementById('suggestionsBox').style.display = 'none';
            }
        });
    
        document.addEventListener('click', function(event) {
            const suggestionsBox = document.getElementById('suggestionsBox');
            const messageInput = document.getElementById('messageInput');
    
            // Check if the clicked element is inside the suggestions box or the input field
            if (!suggestionsBox.contains(event.target) && event.target !== messageInput) {
                suggestionsBox.style.display = 'none'; // Hide the box
            }
        });
    
    
        // Function to display suggestions
        function showSuggestions(suggestions) {
        const suggestionsBox = document.getElementById('suggestionsBox');
        suggestionsBox.innerHTML = ''; // Clear any old suggestions
    
        if (!suggestions || !suggestions.suggestions || suggestions.suggestions.length === 0) {
            // If there are no suggestions, show a "no results" message
            const noResult = document.createElement('div');
            noResult.textContent = 'No suggestions found';
            suggestionsBox.appendChild(noResult);
            return; // Stop the function here
        }
    
        // Loop through each suggestion and create a button
        suggestions.suggestions.forEach(suggestion => {
            const button = document.createElement('button');
            button.textContent = suggestion.question; // Use the question as the button text
            button.classList.add('suggestion-button'); // Add a class for styling
    
            // When the button is clicked, open the side panel
            button.addEventListener('click', () => {
                openSidePanel(suggestion.question, suggestion.message_id);
            });
    
            suggestionsBox.appendChild(button); // Add the button to the suggestion box
        });
    }
    });
    
    
    
    
    
    
    
    document.addEventListener("DOMContentLoaded", function () {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const roomId = "{{ room_id|escapejs }}";
        const currentStudentName = "{{ current_student_name|escapejs }}";
    
        tabButtons.forEach(button => {
            button.addEventListener("click", function () {
                const tabName = this.getAttribute("data-tab");
                sendTabClickData(tabName, roomId, currentStudentName);
    
                tabContents.forEach(content => {
                    content.style.display = "none";
                });
    
                document.getElementById(tabName).style.display = "block";
    
                tabButtons.forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
    
                if (tabName === "bookmarks") {
                    fetchBookmarks(roomId, currentStudentName);
                }
            });
        });
    
        function sendTabClickData(tabName, room_id, username) {
            fetch("/log-tab-click/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ tab_name: tabName, roomId: room_id, username: username })
            })
            .then(response => response.json())
            .then(data => console.log("Tab click logged:", data))
            .catch(error => console.error("Error logging tab click:", error));
        }
    
        function fetchBookmarks(room_id, username) {
            fetch("/log-tab-click/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ tab_name: "bookmarked", roomId: room_id, username: username })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success" && data.bookmarked_messages) {
                    updateBookmarksUI(data.bookmarked_messages);
                } else {
                    console.error("Error fetching bookmarks:", data.message);
                }
            })
            .catch(error => console.error("Fetch error:", error));
        }
    
        function updateBookmarksUI(bookmarks) {
            const bookmarksList = document.querySelector(".bookmarks-list");
            bookmarksList.innerHTML = ""; // Clear previous content
    
            if (bookmarks.length > 0) {
                bookmarks.forEach(bookmark => {
                    const listItem = document.createElement("li");
                    const button = document.createElement("button");
                    button.textContent = bookmark.message;
                    button.classList.add("bookmark-button");
                    button.onclick = function() {
                        openSidePanel(bookmark.message, bookmark.question_id);
                    };
                    listItem.appendChild(button);
                    bookmarksList.appendChild(listItem);
                });
            } else {
                bookmarksList.innerHTML = "<li>No bookmarks available.</li>";
            }
        }
    
        function getCookie(name) {
            const cookies = document.cookie.split("; ");
            for (let cookie of cookies) {
                let [key, value] = cookie.split("=");
                if (key === name) return decodeURIComponent(value);
            }
        }
    });
    
    
    
    
    
    
    
    
    const userVotes = {}; // To track user votes: {replyId: "up"|"down"|null}
    
    function attachVoteHandlers() {
        // Add event listeners to all vote buttons
        document.querySelectorAll(".vote-button").forEach(button => {
            button.addEventListener("click", function() {
                const replyId = this.dataset.replyId;
                const voteType = this.classList.contains("upvote") ? "up" : "down";
                handleVote(replyId, voteType, this);
            });
        });
    }
    
    function handleVote(replyId, voteType, buttonElement) {
        // Get the opposing button (if upvote was clicked, get the downvote button and vice versa)
        const container = buttonElement.closest('.reply-footer');
        const upvoteButton = container.querySelector('.upvote');
        const downvoteButton = container.querySelector('.downvote');
        const voteCountElement = container.querySelector('.vote-count');
        const currentVoteCount = parseInt(voteCountElement.textContent.trim(), 10) || 0;
        
        // Get current vote state for this reply
        const currentVote = userVotes[replyId];
        
        // User is clicking the same button they already voted on - remove vote
        if (currentVote === voteType) {
            // Remove vote styling
            buttonElement.classList.remove('voted');
            
            // Send request to remove vote
            sendVoteRequest(replyId, 'remove', currentVoteCount, voteCountElement);
            
            // Update tracking
            userVotes[replyId] = null;
            
            showToast(`Vote removed`, "info");
            return;
        }
        
        // User is changing vote from one type to another
        if (currentVote && currentVote !== voteType) {
            // Remove styling from previous vote
            if (currentVote === 'up') {
                upvoteButton.classList.remove('voted');
            } else {
                downvoteButton.classList.remove('voted');
            }
            
            // Add styling to new vote
            buttonElement.classList.add('voted');
            
            // Send request to change vote
            sendVoteRequest(replyId, 'change', currentVoteCount, voteCountElement, voteType, currentVote);
            
            // Update tracking
            userVotes[replyId] = voteType;
            
            showToast(`Vote changed to ${voteType}vote`, "info");
            return;
        }
        
        // User is voting for the first time
        buttonElement.classList.add('voted');
        
        // Send request to add vote
        sendVoteRequest(replyId, 'add', currentVoteCount, voteCountElement, voteType);
        
        // Update tracking
        userVotes[replyId] = voteType;
        
        showToast(`${voteType === 'up' ? 'Upvoted' : 'Downvoted'} reply`, "success");
    }
    
    function sendVoteRequest(replyId, action, currentCount, countElement, newVote = null, oldVote = null) {
        // Immediately update the UI optimistically
        let newCount = currentCount;
        
        if (action === 'add') {
            newCount += newVote === 'up' ? 1 : -1;
        } else if (action === 'remove') {
            newCount += userVotes[replyId] === 'up' ? -1 : 1;
        } else if (action === 'change') {
            // If changing from up to down, that's -2 (remove up, add down)
            // If changing from down to up, that's +2 (remove down, add up)
            newCount += newVote === 'up' ? 2 : -2;
        }
        
        // Update the UI immediately
        countElement.textContent = newCount;
        
        // Make the API request
        fetch('/vote-reply/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reply_id: replyId,
                vote_type: newVote,
                username: currentUserName,
                action: action,
                old_vote: oldVote
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // If there was an error, revert the UI
                countElement.textContent = currentCount;
                showToast(data.error || "Error updating vote", "error");
                
                // Revert the vote tracking
                if (action === 'add') {
                    userVotes[replyId] = null;
                } else if (action === 'remove') {
                    userVotes[replyId] = oldVote;
                } else if (action === 'change') {
                    userVotes[replyId] = oldVote;
                }
                
                // Revert the UI classes
                const container = countElement.closest('.reply-footer');
                const upvoteButton = container.querySelector('.upvote');
                const downvoteButton = container.querySelector('.downvote');
                
                upvoteButton.classList.remove('voted');
                downvoteButton.classList.remove('voted');
                
                if (userVotes[replyId] === 'up') {
                    upvoteButton.classList.add('voted');
                } else if (userVotes[replyId] === 'down') {
                    downvoteButton.classList.add('voted');
                }
            } else {
                // Update the count with the actual value from the server
                if (data.newCount !== undefined) {
                    countElement.textContent = data.newCount;
                }
            }
        })
        .catch(error => {
            console.error('Error updating vote:', error);
            showToast("Network error while voting", "error");
            
            // Revert the UI
            countElement.textContent = currentCount;
        });
    }
    
    // Function to get the current vote for a reply
    function fetchUserVotes() {
        // Get all reply IDs currently visible in the side panel
        const replyIds = [];
        document.querySelectorAll('.reply-footer .vote-button').forEach(button => {
            const replyId = button.dataset.replyId;
            if (replyId && !replyIds.includes(replyId)) {
                replyIds.push(replyId);
            }
        });
        
        if (replyIds.length === 0) return;
        
        // Fetch vote status for these replies
        fetch('/get-user-votes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                username: currentUserName,
                reply_ids: replyIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.votes) {
                // Update userVotes and UI
                Object.entries(data.votes).forEach(([replyId, voteType]) => {
                    userVotes[replyId] = voteType;
                    
                    // Update UI to show voted state
                    const container = document.querySelector(`.vote-button[data-reply-id="${replyId}"]`).closest('.reply-footer');
                    const upvoteButton = container.querySelector('.upvote');
                    const downvoteButton = container.querySelector('.downvote');
                    
                    upvoteButton.classList.remove('voted');
                    downvoteButton.classList.remove('voted');
                    
                    if (voteType === 'up') {
                        upvoteButton.classList.add('voted');
                    } else if (voteType === 'down') {
                        downvoteButton.classList.add('voted');
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error fetching vote status:', error);
        });
    }
    
    // CSS for voted buttons
    const voteStyles = `
    .vote-button.voted {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    .vote-button.upvote.voted i {
        color: white;
    }
    .vote-button.downvote.voted i {
        color: white;
    }
    `;
    
    // Add the styles to the head
    document.head.insertAdjacentHTML('beforeend', `<style>${voteStyles}</style>`);
    
    
    
    
    
    
    
    document.addEventListener("DOMContentLoaded", function () {
        const attachFileButton = document.getElementById("attachFileButton");
        const uploadMenu = document.getElementById("upload-menu");
        const uploadFileButton = document.getElementById("upload-file");
        const uploadVideoButton = document.getElementById("upload-video");
        const fileInput = document.getElementById("file-input");
        const videoInput = document.getElementById("videoInput");  // Video input for videos
        const messageInput = document.getElementById("messageInput"); // Input for the message
        const fileMessageInput = document.getElementById("fileMessageInput"); // Input for the file message
        const fileMessageContainer = document.getElementById("fileMessageContainer"); // Floating message box container
        let selectedFile = null;
        let selectedVideo = null;
        const roomId = "{{ room_id|escapejs }}";
        const currentStudentName = "{{ current_student_name|escapejs }}";
    
        attachFileButton.addEventListener("click", function () {
            uploadMenu.style.display = uploadMenu.style.display === "none" ? "block" : "none";
        });
    
        document.addEventListener("click", function (event) {
            if (!attachFileButton.contains(event.target) && !uploadMenu.contains(event.target)) {
                uploadMenu.style.display = "none";
            }
        });
    
        uploadFileButton.addEventListener("click", function () {
            fileInput.click(); // Opens file picker
            uploadMenu.style.display = "none"; // Hide menu after clicking
        });
    
        fileInput.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;
    
        console.log("Selected file:", file);
    
        let isImage = file.type.startsWith("image/");
        let isVideo = file.type.startsWith("video/");
        let isOtherFile = !isImage && !isVideo;
    
        fileMessageContainer.style.display = "inline-block";
    
        const reader = new FileReader();
    
        reader.onload = function (e) {
            const fileData = e.target.result.split(",")[1]; // Base64 data
    
            document.getElementById("sendAttachedMessageButton").addEventListener("click", function () {
                const messageText = fileMessageInput.value.trim() || (isImage ? "My image" : "My file");
    
                const message = {
                    file: fileData,
                    message: messageText,
                    file_name: file.name,
                    file_type: file.type,
                    role: "student",
                    room_url: roomId,
                    sender: currentStudentName,
                    created_at: new Date().toISOString(),
                    is_file: true,
                    is_image: isImage,
                    is_video: isVideo,
                };
    
                console.log("Message being sent:", message);
                window.socket.send(JSON.stringify(message));
    
                fileMessageInput.value = "";
                fileMessageContainer.style.display = "none";
    
                console.log("Message sent!");
            });
        };
    
        reader.readAsDataURL(file); // Convert file to base64
    });
    
    
    
    
        // Handle Video Upload Click
        uploadVideoButton.addEventListener("click", function () {
            videoInput.click(); // Open the file picker for video files
            uploadMenu.style.display = "none"; // Hide the upload menu
        });
    
        videoInput.addEventListener("change", function (event) {
            const video = event.target.files[0]; // Get the selected video file
            if (!video) return; // Exit if no video is selected
    
            console.log("Selected video:", video);
    
            const videoType = video.type; // Get MIME type of the video
    
            // Check if it's a valid video file
            if (!videoType.startsWith("video/")) {
                console.log("This is not a valid video file.");
                alert("Please select a valid video file.");
                return;
            }
    
            fileMessageContainer.style.display = "inline-block";
    
            const reader = new FileReader();
    
            reader.onload = function (e) {
                const videoData = e.target.result.split(",")[1]; // Extract base64 data
    
                document.getElementById("sendAttachedMessageButton").addEventListener("click", function () {
                    const messageText = fileMessageInput.value.trim() || "My video"; // Default to "My video" if no message
    
                    const message = {
                        file: videoData,
                        message: messageText, // Attached message
                        file_name: video.name,
                        file_type: video.type,
                        role: "student",
                        room_url: roomId,
                        sender: currentStudentName,
                        created_at: new Date().toISOString(),
                        is_file: true,
                        is_video: true, // Flag indicating it's a video
                    };
    
                    console.log(message)
    
                    window.socket.send(JSON.stringify(message));
    
                    fileMessageInput.value = "";
                    fileMessageContainer.style.display = "none"; // Hide the message input
                });
            };
    
            reader.readAsDataURL(video); // Read as DataURL (base64)
        });
    
    
        document.getElementById("cancelMessageButton").addEventListener("click", function () {
            fileMessageInput.value = "";
            fileMessageContainer.style.display = "none"; // Hide the message input
        });
    
    });
    
    
    
        document.addEventListener("DOMContentLoaded", function () {
        if (window.socketInitialized) return;
        window.socketInitialized = true;
    
        const roomId = "{{ room_id|escapejs }}";
        const currentStudentName = "{{ current_student_name|escapejs }}";
        const userRole = "student";
    
        if (!roomId || !currentStudentName || !userRole) {
            console.error("Missing required variables.");
            return;
        }
    
        const socketURL = `ws://${window.location.host}/ws/${userRole}s-dashboard/hub-room/${roomId}/`;
    
        if (!window.socket || window.socket.readyState !== WebSocket.OPEN) {
            window.socket = new WebSocket(socketURL);
        } else {
            console.log("WebSocket already open.");
            return;
        }
    
        const socket = window.socket;
        const chatMessages = document.getElementById("chatMessages");
        const messageInput = document.getElementById("messageInput");
        const sendMessageButton = document.getElementById("sendMessageButton");
    
        const scrollToBottom = () => {
            if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        };
    
        // Function to attach click event to a message element
        function attachMessageClickHandler(messageElement) {
            messageElement.addEventListener("click", function () {
                const messageContent = messageElement.dataset.message || messageElement.querySelector(".message-content").textContent;
                const messageId = messageElement.dataset.messageId;
                const roomId = "{{ room_id|escapejs }}";
    
                if (!messageId) {
                    console.error("Missing messageId:", messageElement);
                    return;
                }
    
                const newUrl = `/students-dashboard/hub-room/${roomId}/${messageId}`;
                window.history.pushState({ path: newUrl }, "", newUrl);
                openSidePanel(messageContent, messageId);
            });
        }
    
    
        function createMessageElement(sender, message, createdAt, role, messageId, imageUrl, fileUrl, videoUrl, pollOptions, roomUrl) {
        const newMessage = document.createElement("div");
        newMessage.className = "message-box";
        newMessage.dataset.message = message;
        newMessage.dataset.messageId = messageId;
    
        // Set appropriate class based on sender
        if (sender === currentUserName) {
            newMessage.classList.add(role === "teacher" ? "current-teacher-message" : "current-user-message");
        } else if (role === "teacher") {
            newMessage.classList.add("teacher-message");
        } else {
            newMessage.classList.add("other-user-message");
        }
    
        // Create sender span
        const senderSpan = document.createElement("span");
        senderSpan.className = "message-sender";
        senderSpan.textContent = sender === currentUserName ? "Me" : sender;
        newMessage.appendChild(senderSpan);
    
        // Handle image if present
        if (imageUrl) {
            const imgLink = document.createElement("a");
            imgLink.href = imageUrl;
            imgLink.target = "_blank";
            imgLink.className = "message-image";
    
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            imgElement.style.maxWidth = "400px";
            imgElement.style.height = "200px";
    
            imgLink.appendChild(imgElement);
            newMessage.appendChild(imgLink);
        }
    
        // Handle file if present
        if (fileUrl) {
            const fileDiv = document.createElement("div");
            fileDiv.className = "message-file";
    
            const fileLink = document.createElement("a");
            fileLink.href = fileUrl;
            fileLink.target = "_blank";
    
            const fileIcon = document.createElement("img");
            fileIcon.src = "https://cdn-icons-png.flaticon.com/512/337/337946.png";
            fileIcon.alt = "File";
            fileIcon.style.width = "100px";
            fileIcon.style.height = "100px";
    
            fileLink.appendChild(fileIcon);
            fileDiv.appendChild(fileLink);
            
            if (message && message !== "my file") {
                const messageText = document.createElement("span");
                messageText.textContent = message;
                fileDiv.appendChild(messageText);
            }
            
            newMessage.appendChild(fileDiv);
        }
    
        // Handle video if present
        else if (videoUrl) {
            const videoDiv = document.createElement("div");
            videoDiv.className = "message-video";
    
            const videoElement = document.createElement("video");
            videoElement.src = videoUrl;
            videoElement.controls = true;
            videoElement.style.maxWidth = "200px";
            videoElement.style.maxHeight = "200px";
    
            videoDiv.appendChild(videoElement);
            newMessage.appendChild(videoDiv);
        }
    
        // Handle poll if present
        else if (pollOptions) {
        // Use our enhanced poll display function
        const pollContainer = createPollElement(message, messageId, pollOptions, roomUrl);
        newMessage.appendChild(pollContainer);
    }
        else {
            // Plain text message
            const contentSpan = document.createElement("div");
            contentSpan.className = "message-text";
            contentSpan.textContent = message;
            newMessage.appendChild(contentSpan);
            
            // Add the top reply section for non-poll messages
            const topReplyDiv = document.createElement("div");
            topReplyDiv.className = "top-reply no-reply";
            
            const emText = document.createElement("em");
            emText.textContent = "No replies yet.";
            
            topReplyDiv.appendChild(emText);
            newMessage.appendChild(topReplyDiv);
        }
    
        // Add timestamp
        const timeSpan = document.createElement("span");
        timeSpan.className = "message-time";
        timeSpan.textContent = typeof createdAt === 'string' ? createdAt : 
                              (createdAt instanceof Date ? createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                              new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        newMessage.appendChild(timeSpan);
    
        // Add click event to open side panel for non-poll messages
        if (!pollOptions) {
            newMessage.addEventListener("click", function() {
                openSidePanel(message, messageId);
            });
        }
    
        return newMessage;
    }
    
    
    function createPollElement(message, messageId, pollOptions, roomUrl) {
        const pollContainer = document.createElement("div");
        pollContainer.classList.add("message-poll");
    
        const question = document.createElement("strong");
        question.textContent = message;
        pollContainer.appendChild(question);
    
        const form = document.createElement("form");
        form.id = `poll-form-${messageId}`;
        form.dataset.messageId = messageId;
        form.dataset.roomId = roomUrl;
    
        const optionsList = document.createElement("ul");
        optionsList.style.listStyle = "none";
        optionsList.style.padding = "0";
        optionsList.style.margin = "10px 0";
    
        // Calculate total votes for percentages
        let totalVotes = 0;
        pollOptions.forEach(option => {
            totalVotes += option.votes || 0;
        });
    
        pollOptions.forEach((option, index) => {
            const optionText = option.option;
            const votes = option.votes || 0;
            const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
    
            const optionItem = document.createElement("li");
            optionItem.style.margin = "8px 0";
            optionItem.style.padding = "5px";
    
            // Radio button for voting
            const radioContainer = document.createElement("div");
            radioContainer.style.display = "flex";
            radioContainer.style.alignItems = "center";
            radioContainer.style.marginBottom = "5px";
    
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.id = `option-${messageId}-${index + 1}`;
            radio.name = `poll-option-${messageId}`;
            radio.value = optionText;
            radio.style.marginRight = "8px";
    
            const label = document.createElement("label");
            label.htmlFor = `option-${messageId}-${index + 1}`;
            label.textContent = optionText;
            label.style.margin = "0";
            label.style.fontSize = "14px";
            label.style.cursor = "pointer";
    
            radioContainer.appendChild(radio);
            radioContainer.appendChild(label);
            optionItem.appendChild(radioContainer);
    
            // Results display
            const resultsContainer = document.createElement("div");
            
            // Option text and vote count
            const optionInfoDiv = document.createElement("div");
            optionInfoDiv.className = "poll-option-votes";
            
            const optionTextSpan = document.createElement("span");
            optionTextSpan.className = "poll-option-text";
            optionTextSpan.textContent = `${percentage}%`;
            
            const voteCountSpan = document.createElement("span");
            voteCountSpan.className = "poll-option-count";
            voteCountSpan.id = `vote-count-${messageId}-${index + 1}`;
            voteCountSpan.textContent = votes;
            
            optionInfoDiv.appendChild(optionTextSpan);
            optionInfoDiv.appendChild(voteCountSpan);
            resultsContainer.appendChild(optionInfoDiv);
            
            // Progress bar
            const progressBar = document.createElement("div");
            progressBar.className = "poll-results-bar";
            
            const progressFill = document.createElement("div");
            progressFill.className = "poll-results-fill";
            progressFill.style.width = `${percentage}%`;
            
            progressBar.appendChild(progressFill);
            resultsContainer.appendChild(progressBar);
            
            optionItem.appendChild(resultsContainer);
            optionsList.appendChild(optionItem);
        });
    
        form.appendChild(optionsList);
    
        const voteButton = document.createElement("button");
        voteButton.type = "button";
        voteButton.classList.add("poll-vote-button");
        voteButton.id = `poll-vote-${messageId}`;
        voteButton.textContent = "Vote";
        voteButton.style.marginTop = "10px";
        voteButton.onclick = function() {
            submitPollVote(messageId, roomUrl);
        };
    
        form.appendChild(voteButton);
        pollContainer.appendChild(form);
        
        return pollContainer;
    }
    
    
    
    socket.onopen = () => console.log("WebSocket connection established.");
    socket.onmessage = function (event) {
        try {
            const data = JSON.parse(event.data);
            const messageData = data.message;
    
            if (data.is_reply) {
                return;
            } else {
                if (messageData.question_id) {
                    return;
                } else {
                    const chatMessages = document.getElementById("chatMessages");
                    
                    // Format the timestamp
                    const formattedTime = new Date(messageData.created_at).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                    
                    // Create the message element using our improved function
                    const newMessage = createMessageElement(
                        messageData.sender,
                        messageData.message,
                        formattedTime,
                        messageData.role || "student",
                        messageData.message_id,
                        messageData.image_url,
                        messageData.file_url,
                        messageData.video_url,
                        messageData.is_poll ? messageData.poll_options : null,
                        messageData.room_url || currentRoomId
                    );
                    
                    chatMessages.appendChild(newMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        } catch (error) {
            console.error("❌ Error handling message for student:", error);
        }
    };
    
    
    
        socket.onerror = (error) => console.error("WebSocket error:", error);
        socket.onclose = () => console.log("WebSocket connection closed.");
    
        // Send message button event listener
        if (sendMessageButton && messageInput) {
            sendMessageButton.addEventListener("click", () => {
                const replyText = messageInput.value.trim();
                if (replyText) {
                    socket.send(
                        JSON.stringify({
                            message: replyText,
                            role: "student",
                            room_url: roomId,
                            sender: currentStudentName,
                            created_at: new Date().toISOString(),
                            reply:false
                        })
                    );
                    messageInput.value = "";
                } else {
                    alert("Please enter a message before sending.");
                }
            });
        }
    
        // Attach click event to existing messages on page load
        document.querySelectorAll(".message-box").forEach(attachMessageClickHandler);
    
        // Debugging: Log message IDs after loading
        setTimeout(() => {
            document.querySelectorAll(".message-box").forEach(msg => {
                console.log("Loaded Message ID:", msg.dataset.messageId);
            });
        }, 1000);
    
        scrollToBottom();
    });
    
    
    
    
    
    
let currentMessageId = null;
    
function openSidePanel(messageContent, messageId) {
    const sidePanel = document.getElementById('side-panel');
    const panelTitle = document.getElementById('panel-title');
    const chatSection = document.querySelector('.chat-section');
    const rightSidebar = document.querySelector('.right-sidebar');
    
    // Current sort method - initialized to 'recent' by default
    let currentSortMethod = 'recent';

    if (sidePanel.classList.contains('open')) {
        // Close the side panel
        sidePanel.classList.remove('open');
        chatSection.style.marginLeft = '0';
        rightSidebar.style.marginLeft = '0';

        // Reset the URL to remove messageId
        const newUrl = `/students-dashboard/hub-room/${currentRoomId}/`;
        window.history.pushState({ path: newUrl }, "", newUrl);

        // Reset the global messageId
        currentMessageId = null;
    } else {
        // Open the side panel
        
        // Set the title text with ellipsis handled by CSS
        panelTitle.textContent = messageContent;
        
        // Also set the title attribute for showing the full text on hover
        panelTitle.title = messageContent;
        
        sidePanel.classList.add('open');
        chatSection.style.marginLeft = '250px';
        rightSidebar.style.marginLeft = 'none';

        // Store the messageId in the global variable
        currentMessageId = messageId;

        // Load replies with the default sort method (recent)
        loadReplies(messageId, currentSortMethod);
        
        // Ensure sort buttons show the correct active state
        updateSortButtonState(currentSortMethod);

        // Check bookmark status and add listeners
        addBookmarkButtonListener();
    }
    
    // Function to load replies with the given sort method
    function loadReplies(messageId, sortMethod) {
        // Construct the URL with the sort parameter
        const newUrl = `/students-dashboard/hub-room/${currentRoomId}/${messageId}/?sort=${sortMethod}`;
        
        // Update browser URL without the query parameter
        const displayUrl = `/students-dashboard/hub-room/${currentRoomId}/${messageId}/`;
        window.history.pushState({ path: displayUrl }, "", displayUrl);

        // Show loading indicator
        const messagesArea = document.getElementById('sidePanelMessages');
        if (messagesArea) {
            messagesArea.innerHTML = '<div class="loading-replies">Loading replies...</div>';
        }

        // Fetch replies from the server with the sort parameter
        fetch(newUrl, {
            method: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (messagesArea) {
                messagesArea.innerHTML = '';  // Clear existing messages
            }

            if (data.length === 0) {
                messagesArea.innerHTML = '<div class="no-replies">No replies yet. Be the first to reply!</div>';
                return;
            }

            // Iterate through the messages and append them to the side panel
            data.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('side-panel-message');

                // Update content based on new design
                messageElement.innerHTML = `
                    <div class="reply">
                    <div class="reply-header">
                        <span class="reply-info">${message.sender}</span>
                        <span class="reply-role">(${message.role})</span>
                    </div>
                    <p class="reply-content">${message.reply_content}</p>
                    
                    <div class="reply-footer">
                        <button class="vote-button upvote" data-reply-id="${message.reply_id}">
                            <i class="fa fa-arrow-up"></i>
                        </button>
                        <span class="vote-count" id="vote-count-${message.reply_id}">
                            ${message.upvotes - message.downvotes}
                        </span>
                        <button class="vote-button downvote" data-reply-id="${message.reply_id}">
                            <i class="fa fa-arrow-down"></i>
                        </button>
                    </div>
                    </div>
                `;
                messagesArea.appendChild(messageElement);
            });

            // After appending all messages, attach vote handlers and fetch vote status
            attachVoteHandlers();
            fetchUserVotes();
        })
        .catch(error => {
            console.error("Error fetching message:", error);
            if (messagesArea) {
                messagesArea.innerHTML = '<div class="error-message">Error loading replies. Please try again.</div>';
            }
        });
    }

    // Setup sort button event listeners if side panel is opening
    if (!sidePanel.classList.contains('open')) {
        // Add listeners to sort buttons if not already added
        const sortButtons = document.querySelectorAll('.sort-button');
        sortButtons.forEach(button => {
            // Remove existing listeners to prevent duplicates
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Add new listener
            newButton.addEventListener('click', function() {
                const sortMethod = this.getAttribute('data-sort');
                
                // Skip if already using this sort method
                if (sortMethod === currentSortMethod) return;
                
                // Update current sort method
                currentSortMethod = sortMethod;
                
                // Update active button state
                updateSortButtonState(sortMethod);
                
                // Reload replies with new sort method
                loadReplies(currentMessageId, currentSortMethod);
            });
        });
    }
    
    // Function to update the active state of sort buttons
    function updateSortButtonState(activeMethod) {
        const sortButtons = document.querySelectorAll('.sort-button');
        sortButtons.forEach(button => {
            if (button.getAttribute('data-sort') === activeMethod) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
}
    
    function addBookmarkButtonListener() {
        const bookmarkButton = document.getElementById('bookmark-button');
    
        if (bookmarkButton) {
            // First, check if the bookmark status and update button UI accordingly
            checkBookmarkStatus();
            
            // Remove any existing event listener to prevent duplicates
            bookmarkButton.removeEventListener('click', handleBookmarkClick);
            
            // Add the event listener
            bookmarkButton.addEventListener('click', handleBookmarkClick);
        } else {
            console.error("Bookmark button not found");
        }
    }
    
    // Function to check if a question is already bookmarked
    function checkBookmarkStatus() {
        const bookmarkButton = document.getElementById('bookmark-button');
        const username = currentUserName; // Make sure this variable is defined in your context
        const questionId = currentMessageId;
        const roomId = currentRoomId; // Make sure this variable is defined in your context
        
        if (!questionId) return;
        
        fetch("/check-bookmark-status/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ username, questionId, roomId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_bookmarked) {
                bookmarkButton.classList.add('bookmarked');
            } else {
                bookmarkButton.classList.remove('bookmarked');
            }
        })
        .catch(error => {
            console.error('Error checking bookmark status:', error);
        });
    }
    
    // Event handler for bookmark button clicks
    function handleBookmarkClick() {
        const username = currentUserName; // Make sure this variable is defined
        const questionId = currentMessageId;
        const roomId = currentRoomId; // Make sure this variable is defined
        const button = this;
        
        if (!questionId) {
            showToast("Error: Cannot identify the question to bookmark", "error");
            return;
        }
        
        button.disabled = true; // Prevent multiple clicks
        
        if (button.classList.contains('bookmarked')) {
            removeBookmark(username, questionId, roomId, button);
        } else {
            addBookmark(username, questionId, roomId, button);
        }
    }
    
    function removeBookmark(username, questionId, roomId, button) {
        showToast("Removing bookmark...", "info");
        
        fetch("/remove-bookmark-queston/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ username, questionId, roomId })
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            if (data.message === 'Bookmark removed successfully!') {
                button.classList.remove('bookmarked');
                showToast("Removed from bookmarks", "success");
            } else {
                showToast("Failed to remove bookmark", "error");
                console.error('Failed to remove bookmark:', data.error);
            }
        })
        .catch(error => {
            button.disabled = false;
            showToast("Network error", "error");
            console.error('Error removing bookmark:', error);
        });
    }
    
    function addBookmark(username, questionId, roomId, button) {
        showToast("Adding bookmark...", "info");
        
        fetch("/bookmark-questions/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ username, questionId, roomId })
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            if (data.message === 'Already bookmarked!') {
                button.classList.add('bookmarked');
                showToast("Already in your bookmarks", "info");
            } else if (data.message === 'Bookmark saved successfully!') {
                button.classList.add('bookmarked');
                showToast("Added to bookmarks", "success");
            } else {
                showToast("Failed to add bookmark", "error");
                console.error('Failed to add bookmark:', data.error);
            }
        })
        .catch(error => {
            button.disabled = false;
            showToast("Network error", "error");
            console.error('Error adding bookmark:', error);
        });
    }
    
    // A better toast notification system
    function showToast(message, type) {
        // Remove any existing toast
        const existingToast = document.getElementById('toast-notification');
        if (existingToast) {
            existingToast.remove();
        }
        
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.position = 'fixed';
            toastContainer.style.bottom = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast
        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.backgroundColor = type === 'error' ? '#f44336' : 
                                      type === 'success' ? '#4CAF50' : 
                                      type === 'info' ? '#2196F3' : '#333';
        toast.style.color = 'white';
        toast.style.padding = '16px';
        toast.style.borderRadius = '4px';
        toast.style.marginTop = '10px';
        toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        toast.style.minWidth = '250px';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        toast.textContent = message;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Fade in
        setTimeout(() => {
            toast.style.opacity = '1';
        }, 10);
        
        // Fade out after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    
    
    
    
    let socket;
    const roomId = "{{ room_id|escapejs }}";
    const socketUrl = `ws://${window.location.host}/ws/students-dashboard/hub-room/${roomId}/`;
    
    function initializeWebSocket() {
        if (!socket || socket.readyState === WebSocket.CLOSED) {
            socket = new WebSocket(socketUrl);
    
            socket.onopen = function () {
                console.log("✅ WebSocket connection established.");
            };
    
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    const messageData = data.message;
    
    
                    if (messageData && messageData.question_id) {
                        console.log("💬 Processing reply:", messageData);
    
                        const replyText = messageData.message || "No reply content";
                        const messagesArea = document.getElementById('sidePanelMessages');
    
                        // Create reply element
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('side-panel-message');
                        messageElement.innerHTML = `
                            <div class="reply">
                                <div class="reply-header">
                                    <span class="reply-info">${messageData.sender}</span>
                                    <span class="reply-role">(${messageData.role})</span>
                                </div>
                                <p class="reply-content">${replyText}</p>
                                <div class="reply-footer">
                                    <button class="vote-button upvote" data-reply-id="${messageData.reply_id}">
                                        <i class="fa fa-arrow-up"></i>
                                    </button>
                                    <span class="vote-count" id="vote-count-${messageData.reply_id}">
                                        ${messageData.upvotes - messageData.downvotes}
                                    </span>
                                    <button class="vote-button downvote" data-reply-id="${messageData.reply_id}">
                                        <i class="fa fa-arrow-down"></i>
                                    </button>
                                </div>
                            </div>
                        `;
    
                        messagesArea.appendChild(messageElement);
    
                        messageElement.querySelectorAll(".vote-button").forEach(button => {
                            button.addEventListener("click", function () {
                                const replyId = this.dataset.replyId;
                                const voteType = this.classList.contains("upvote") ? "up" : "down";
                                vote(replyId, voteType); // Call your vote function
                            });
                        });
    
                    } else {
                        console.log("🚫 Not a reply, ignoring.");
                    }
                } catch (error) {
                    console.error("❌ Error handling message:", error);
                }
            };
    
            socket.onerror = (e) => console.error("⚠️ WebSocket error:", e);
            socket.onclose = (e) => console.log("🔒 WebSocket closed:", e);
        }
    }
    
    // Initialize WebSocket on page load
    initializeWebSocket();
    
    document.getElementById('sidePanelSendButton').addEventListener('click', function () {
        const inputField = document.getElementById('sidePanelInput');
        const replyText = inputField.value.trim();
    
        if (!replyText) {
            alert('Please enter a message before sending.');
            return;
        }
    
        if (!currentMessageId) {
            alert("Message ID is missing!");
            return;
        }
    
        inputField.value = ''; // Clear the input field
    
        const sender = "{{ current_student_name|escapejs }}";  
        const createdAt = new Date().toISOString();  
        const messageType = "text";  
        const upvotes = 0;  
        const downvotes = 0;  
    
        const messageData = {
            question_id: currentMessageId,
            message: replyText,
            sender: sender,
            created_at: createdAt,
            message_type: messageType,
            upvotes: upvotes,
            downvotes: downvotes,
            room_url: roomId,
            role: "STUDENT",
            reply: true
        };
    
        // Ensure WebSocket is open before sending
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(messageData));
        } else {
            console.error("WebSocket is not open. Reconnecting...");
            initializeWebSocket(); // Reinitialize if needed
            setTimeout(() => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(messageData));
                    console.log("I have sent the reply")
                } else {
                    console.error("WebSocket connection failed.");
                }
            }, 500); 
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check if there's a questionId in sessionStorage
        const questionId = sessionStorage.getItem('openQuestionId');
        
        if (questionId) {
            console.log("I am here now, it will work")
            // Clear it from session storage so it doesn't trigger again on refresh
            sessionStorage.removeItem('openQuestionId');
            
            // Find the message box with this question ID
            const messageBox = document.querySelector(`.message-box[data-message-id="${questionId}"]`);
            
            if (messageBox) {
                // Get the message content
                const messageContent = messageBox.getAttribute('data-message') || messageBox.textContent.trim();
                
                // Wait a moment for everything to load, then open the side panel
                setTimeout(() => {
                    // Open the side panel with this message
                    openSidePanel(messageContent, questionId);
                    
                    // Scroll to the message
                    messageBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Highlight the message temporarily
                    messageBox.style.boxShadow = '0 0 15px rgba(0, 123, 255, 0.7)';
                    setTimeout(() => {
                        messageBox.style.boxShadow = '';
                    }, 3000);
                }, 1000);
            } else {
                console.error(`Message with ID ${questionId} not found`);
            }
        }
    });
    </script>












</body>
</html>