{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>{{ livestream.title }} - LiveStream</title>
  <meta name="description" content="EduLink livestream room for teachers">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- LiveKit JavaScript SDK -->
  <script src="https://unpkg.com/livekit-client@1.11.2/dist/livekit-client.umd.js"></script>
  
  <!-- Vendor CSS Files -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  
  <style>
    .livestream-container {
      display: flex;
      height: calc(100vh - 80px);
      position: relative;
    }
    
    .video-area {
      flex: 1;
      background-color: #1a1a1a;
      position: relative;
      overflow: hidden;
    }
    
    .chat-sidebar {
      width: 300px;
      background-color: #2d2d2d;
      color: #fff;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #3d3d3d;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    
    .chat-input {
      padding: 15px;
      border-top: 1px solid #3d3d3d;
      background-color: #2d2d2d;
    }
    
    .local-stream {
      position: absolute;
      width: 210px;
      height: 120px;
      right: 20px;
      bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #4d4d4d;
      z-index: 10;
    }
    
    .local-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .remote-stream {
      width: 100%;
      height: 100%;
      background-color: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .remote-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .livestream-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 10px;
      z-index: 20;
    }
    
    .control-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.6);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .control-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    
    .control-button i {
      font-size: 20px;
      color: white;
    }
    
    .control-button.danger {
      background-color: #dc3545;
    }
    
    .control-button.danger:hover {
      background-color: #bd2130;
    }
    
    .participant-count {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 5px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      color: white;
      z-index: 10;
    }
    
    .participant-count i {
      margin-right: 5px;
    }
    
    .live-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #dc3545;
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
      display: flex;
      align-items: center;
      font-weight: bold;
      z-index: 10;
    }
    
    .live-indicator::before {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: white;
      border-radius: 50%;
      margin-right: 5px;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }
    
    .stream-placeholder {
      color: white;
      text-align: center;
      margin-top: 40vh;
    }
    
    .stream-placeholder i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.7;
    }
    
    .chat-message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
      word-break: break-word;
    }
    
    .chat-message .sender {
      font-weight: bold;
      margin-bottom: 2px;
    }
    
    .chat-message .time {
      font-size: 0.8em;
      opacity: 0.8;
      margin-left: 5px;
    }
    
    .chat-message.outgoing {
      background-color: #0d6efd;
      color: white;
      margin-left: auto;
    }
    
    .chat-message.incoming {
      background-color: #2d2d2d;
      border: 1px solid #3d3d3d;
      margin-right: auto;
    }
    
    .settings-dropdown {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 15;
    }
    
    .settings-menu {
      position: absolute;
      top: 40px;
      left: 0;
      background-color: #2d2d2d;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      padding: 10px 0;
      min-width: 200px;
      display: none;
    }
    
    .settings-menu.show {
      display: block;
    }
    
    .settings-menu .menu-item {
      padding: 8px 15px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
    }
    
    .settings-menu .menu-item:hover {
      background-color: #3d3d3d;
    }
    
    .settings-menu .menu-item i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .toggle-button {
      position: absolute;
      top: 50%;
      right: 300px;
      transform: translateY(-50%);
      background-color: #2d2d2d;
      border: none;
      color: white;
      width: 24px;
      height: 60px;
      border-radius: 4px 0 0 4px;
      cursor: pointer;
      z-index: 10;
    }
    
    .toggle-button:focus {
      outline: none;
    }
    
    /* States */
    .chat-sidebar.collapsed {
      width: 0;
    }
    
    .muted .mic-icon::before {
      content: "\f131";  /* mic-mute icon */
    }
    
    .video-off .video-icon::before {
      content: "\f4e2";  /* video-slash icon */
    }
    
    .screenshare-active .screen-icon {
      color: #0d6efd;
    }
  </style>
</head>

<body class="livestream-page">
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
      <a href="{% url 'teachers_homepage' %}" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">EduLink</h1>
      </a>
      
      <h3 class="page-title">{{ livestream.title }}</h3>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="#" id="endLivestreamBtn" class="text-danger">
            <i class="bi bi-x-circle"></i> End Livestream
          </a></li>
          <li><a href="{% url 'teachers_homepage' %}">
            <i class="bi bi-house"></i> Dashboard
          </a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="livestream-container">
    <!-- Video Area -->
    <div class="video-area">
      <!-- Live Indicator -->
      <div class="live-indicator">LIVE</div>
      
      <!-- Participant Count -->
      <div class="participant-count">
        <i class="bi bi-people-fill"></i>
        <span id="viewerCount">0</span> viewers
      </div>
      
      <!-- Main Stream Container -->
      <div class="remote-stream" id="remoteContainer">
        <div class="stream-placeholder">
          <i class="bi bi-camera-video"></i>
          <h3>Your livestream will appear here</h3>
          <p>Use the controls below to start sharing your camera or screen</p>
        </div>
      </div>
      
      <!-- Local Stream Preview -->
      <div class="local-stream" id="localContainer">
        <!-- Local video will be inserted here by JavaScript -->
      </div>
      
      <!-- Livestream Controls -->
      <div class="livestream-controls">
        <button class="control-button" id="toggleMicBtn" title="Toggle Microphone">
          <i class="bi bi-mic-fill mic-icon"></i>
        </button>
        <button class="control-button" id="toggleVideoBtn" title="Toggle Camera">
          <i class="bi bi-camera-video-fill video-icon"></i>
        </button>
        <button class="control-button" id="toggleScreenBtn" title="Share Screen">
          <i class="bi bi-display screen-icon"></i>
        </button>
        <button class="control-button danger" id="endStreamBtn" title="End Livestream">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>
    
    <!-- Chat Sidebar -->
    <button class="toggle-button" id="toggleChatBtn">
      <i class="bi bi-chevron-right"></i>
    </button>
    
    <div class="chat-sidebar" id="chatSidebar">
      <div class="chat-messages" id="chatMessages">
        <!-- Chat messages will be inserted here by JavaScript -->
        <div class="system-message">
          <p>Welcome to the livestream chat! Students can send messages here during your stream.</p>
        </div>
      </div>
      
      <div class="chat-input">
        <div class="input-group">
          <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
          <button class="btn btn-primary" id="sendMessageBtn">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- End Livestream Confirmation Modal -->
  <div class="modal fade" id="endStreamConfirmModal" tabindex="-1" aria-labelledby="endStreamConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="endStreamConfirmModalLabel">End Livestream?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to end this livestream? This will disconnect all viewers and stop the recording.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmEndStreamBtn">End Livestream</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden elements for LiveKit integration -->
  <div id="livestream-data" 
    data-token="{{ token }}" 
    data-room="{{ room_name }}" 
    data-username="{{ user_name }}"
    data-livestream-id="{{ livestream.id }}"
    style="display: none;">
  </div>

  <!-- Vendor JS Files -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // LiveKit integration
      const livestreamData = document.getElementById('livestream-data');
      const token = livestreamData.dataset.token;
      const roomName = livestreamData.dataset.room;
      const username = livestreamData.dataset.username;
      const livestreamId = livestreamData.dataset.livestreamId;
      
      // UI elements
      const localContainer = document.getElementById('localContainer');
      const remoteContainer = document.getElementById('remoteContainer');
      const toggleMicBtn = document.getElementById('toggleMicBtn');
      const toggleVideoBtn = document.getElementById('toggleVideoBtn');
      const toggleScreenBtn = document.getElementById('toggleScreenBtn');
      const endStreamBtn = document.getElementById('endStreamBtn');
      const endLivestreamBtn = document.getElementById('endLivestreamBtn');
      const confirmEndStreamBtn = document.getElementById('confirmEndStreamBtn');
      const viewerCountEl = document.getElementById('viewerCount');
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendMessageBtn = document.getElementById('sendMessageBtn');
      const toggleChatBtn = document.getElementById('toggleChatBtn');
      const chatSidebar = document.getElementById('chatSidebar');
      
      // LiveKit room and tracks
      let room;
      let localVideoTrack;
      let localAudioTrack;
      let screenTrack;
      
      // Connection state
      let isMuted = false;
      let isVideoOff = false;
      let isScreenSharing = false;
      let isChatCollapsed = false;
      
      // Initialize the LiveKit room
      async function initializeRoom() {
        try {
          room = new LivekitClient.Room();
          
          // Set up room event listeners
          room.on(LivekitClient.RoomEvent.ParticipantConnected, handleParticipantConnected);
          room.on(LivekitClient.RoomEvent.ParticipantDisconnected, handleParticipantDisconnected);
          room.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrackSubscribed);
          room.on(LivekitClient.RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed);
          room.on(LivekitClient.RoomEvent.DataReceived, handleDataReceived);
          
          // Connect to the room
          await room.connect(LivekitClient.toURL(window.location.origin, roomName), token);
          
          console.log('Connected to room:', room.name);
          
          // Create local tracks (camera and microphone)
          localAudioTrack = await LivekitClient.createLocalAudioTrack({
            echoCancellation: true,
            noiseSuppression: true,
          });
          
          localVideoTrack = await LivekitClient.createLocalVideoTrack();
          
          // Publish local tracks to the room
          await room.localParticipant.publishTrack(localAudioTrack);
          await room.localParticipant.publishTrack(localVideoTrack);
          
          // Add local video to the preview
          const localVideoEl = document.createElement('video');
          localVideoEl.classList.add('local-video');
          localVideoEl.autoplay = true;
          localVideoEl.muted = true;
          localVideoTrack.attach(localVideoEl);
          localContainer.appendChild(localVideoEl);
          
          // Update UI
          updateViewerCount();
          
        } catch (error) {
          console.error('Error connecting to LiveKit room:', error);
          alert('Error connecting to livestream room. Please try again.');
        }
      }
      
      // Handle participant connected event
      function handleParticipantConnected(participant) {
        console.log('Participant connected:', participant.identity);
        updateViewerCount();
        
        // Add system message to chat
        addSystemMessage(`${participant.identity} joined the livestream`);
      }
      
      // Handle participant disconnected event
      function handleParticipantDisconnected(participant) {
        console.log('Participant disconnected:', participant.identity);
        updateViewerCount();
        
        // Add system message to chat
        addSystemMessage(`${participant.identity} left the livestream`);
      }
      
      // Handle track subscribed event
      function handleTrackSubscribed(track, publication, participant) {
        console.log('Track subscribed:', track.kind, 'from', participant.identity);
        
        // Handle screen share specially
        if (track.source === LivekitClient.Track.Source.ScreenShare) {
          // Clear remote container
          remoteContainer.innerHTML = '';
          
          // Create and attach video element
          const videoEl = document.createElement('video');
          videoEl.classList.add('remote-video');
          videoEl.id = 'screen-share-video';
          videoEl.autoplay = true;
          track.attach(videoEl);
          remoteContainer.appendChild(videoEl);
        }
      }
      
      // Handle track unsubscribed event
      function handleTrackUnsubscribed(track, publication, participant) {
        console.log('Track unsubscribed:', track.kind, 'from', participant.identity);
        
        // If it was a screen share, restore the UI
        if (track.source === LivekitClient.Track.Source.ScreenShare) {
          const videoEl = document.getElementById('screen-share-video');
          if (videoEl) {
            track.detach(videoEl);
            videoEl.remove();
          }
          
          // Restore placeholder if needed
          if (remoteContainer.children.length === 0) {
            remoteContainer.innerHTML = `
              <div class="stream-placeholder">
                <i class="bi bi-camera-video"></i>
                <h3>Your livestream will appear here</h3>
                <p>Use the controls below to start sharing your camera or screen</p>
              </div>
            `;
          }
        }
      }
      
      // Handle data received event (chat messages)
      function handleDataReceived(payload, participant) {
        // Parse the data
        const decoder = new TextDecoder();
        const data = JSON.parse(decoder.decode(payload));
        
        console.log('Data received:', data, 'from', participant.identity);
        
        // Handle chat message
        if (data.type === 'chat') {
          addChatMessage(participant.identity, data.message, false);
        }
      }
      
      // Update viewer count
      function updateViewerCount() {
        if (room) {
          // Count all remote participants (excluding local participant)
          const count = room.participants.size;
          viewerCountEl.textContent = count;
        }
      }
      
      // Toggle microphone
      async function toggleMicrophone() {
        if (!room || !localAudioTrack) return;
        
        isMuted = !isMuted;
        
        if (isMuted) {
          await localAudioTrack.mute();
          toggleMicBtn.classList.add('muted');
        } else {
          await localAudioTrack.unmute();
          toggleMicBtn.classList.remove('muted');
        }
      }
      
      // Toggle camera
      async function toggleCamera() {
        if (!room || !localVideoTrack) return;
        
        isVideoOff = !isVideoOff;
        
        if (isVideoOff) {
          await localVideoTrack.mute();
          toggleVideoBtn.classList.add('video-off');
        } else {
          await localVideoTrack.unmute();
          toggleVideoBtn.classList.remove('video-off');
        }
      }
      
      // Toggle screen sharing
      async function toggleScreenSharing() {
        if (!room) return;
        
        if (!isScreenSharing) {
          try {
            // Create screen share track
            screenTrack = await LivekitClient.createLocalScreenShareTrack();
            
            // Publish screen share track
            await room.localParticipant.publishTrack(screenTrack);
            
            // Update UI
            isScreenSharing = true;
            toggleScreenBtn.classList.add('screenshare-active');
            
            // Clear remote container
            remoteContainer.innerHTML = '';
            
            // Add screen share video to remote container
            const screenVideoEl = document.createElement('video');
            screenVideoEl.classList.add('remote-video');
            screenVideoEl.id = 'local-screen-share';
            screenVideoEl.autoplay = true;
            screenVideoEl.muted = true;
            screenTrack.attach(screenVideoEl);
            remoteContainer.appendChild(screenVideoEl);
            
            // Handle screen share ended event
            screenTrack.mediaStreamTrack.onended = () => {
              stopScreenSharing();
            };
          } catch (error) {
            console.error('Error starting screen share:', error);
            
            // User may have cancelled the screen share
            if (error.name !== 'NotAllowedError') {
              alert('Error starting screen share. Please try again.');
            }
          }
        } else {
          stopScreenSharing();
        }
      }
      
      // Stop screen sharing
      async function stopScreenSharing() {
        if (!room || !screenTrack || !isScreenSharing) return;
        
        // Unpublish screen share track
        await room.localParticipant.unpublishTrack(screenTrack);
        
        // Dispose of the track
        screenTrack.stop();
        screenTrack = null;
        
        // Update UI
        isScreenSharing = false;
        toggleScreenBtn.classList.remove('screenshare-active');
        
        // Remove screen share video
        const screenVideoEl = document.getElementById('local-screen-share');
        if (screenVideoEl) {
          screenVideoEl.remove();
        }
        
        // Restore placeholder
        if (remoteContainer.children.length === 0) {
          remoteContainer.innerHTML = `
            <div class="stream-placeholder">
              <i class="bi bi-camera-video"></i>
              <h3>Your livestream will appear here</h3>
              <p>Use the controls below to start sharing your camera or screen</p>
            </div>
          `;
        }
      }
      
      // End the livestream
      async function endLivestream() {
        try {
          // Disconnect from the LiveKit room
          if (room) {
            await room.disconnect();
          }
          
          // Stop all local tracks
          if (localAudioTrack) {
            localAudioTrack.stop();
          }
          
          if (localVideoTrack) {
            localVideoTrack.stop();
          }
          
          if (screenTrack) {
            screenTrack.stop();
          }
          
          // Send API request to end the livestream
          const response = await fetch('/end-livestream/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              livestream_id: livestreamId
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Redirect to the teacher's dashboard
            window.location.href = '{% url "teachers_homepage" %}';
          } else {
            alert('Error ending livestream: ' + data.error);
          }
        } catch (error) {
          console.error('Error ending livestream:', error);
          alert('Error ending livestream. Please try again.');
        }
      }
      
      // Send chat message
      function sendChatMessage() {
        const message = chatInput.value.trim();
        
        if (!message || !room) return;
        
        // Create message data
        const messageData = {
          type: 'chat',
          message: message,
          timestamp: new Date().toISOString()
        };
        
        // Encode and send the message
        const encoder = new TextEncoder();
        const data = encoder.encode(JSON.stringify(messageData));
        
        room.localParticipant.publishData(data, LivekitClient.DataPacket_Kind.RELIABLE);
        
        // Add message to UI
        addChatMessage(username, message, true);
        
        // Clear input
        chatInput.value = '';
      }
      
      // Add chat message to UI
      function addChatMessage(sender, message, isOutgoing) {
        const messageEl = document.createElement('div');
        messageEl.classList.add('chat-message');
        messageEl.classList.add(isOutgoing ? 'outgoing' : 'incoming');
        
        const senderEl = document.createElement('div');
        senderEl.classList.add('sender');
        senderEl.textContent = sender;
        
        const timeEl = document.createElement('span');
        timeEl.classList.add('time');
        timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        senderEl.appendChild(timeEl);
        
        const contentEl = document.createElement('div');
        contentEl.classList.add('content');
        contentEl.textContent = message;
        
        messageEl.appendChild(senderEl);
        messageEl.appendChild(contentEl);
        
        chatMessages.appendChild(messageEl);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // Add system message to chat
      function addSystemMessage(message) {
        const messageEl = document.createElement('div');
        messageEl.classList.add('system-message');
        messageEl.textContent = message;
        
        chatMessages.appendChild(messageEl);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // Toggle chat sidebar
      function toggleChat() {
        isChatCollapsed = !isChatCollapsed;
        
        if (isChatCollapsed) {
          chatSidebar.classList.add('collapsed');
          toggleChatBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
        } else {
          chatSidebar.classList.remove('collapsed');
          toggleChatBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        }
      }
      
      // Helper function to get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // Set up event listeners
      toggleMicBtn.addEventListener('click', toggleMicrophone);
      toggleVideoBtn.addEventListener('click', toggleCamera);
      toggleScreenBtn.addEventListener('click', toggleScreenSharing);
      endStreamBtn.addEventListener('click', () => {
        // Show confirmation modal
        const endStreamModal = new bootstrap.Modal(document.getElementById('endStreamConfirmModal'));
        endStreamModal.show();
      });
      endLivestreamBtn.addEventListener('click', () => {
        // Show confirmation modal
        const endStreamModal = new bootstrap.Modal(document.getElementById('endStreamConfirmModal'));
        endStreamModal.show();
      });
      confirmEndStreamBtn.addEventListener('click', endLivestream);
      sendMessageBtn.addEventListener('click', sendChatMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendChatMessage();
        }
      });
      toggleChatBtn.addEventListener('click', toggleChat);
      
      // Initialize the room
      initializeRoom();
    });
  </script>
</body>
</html>