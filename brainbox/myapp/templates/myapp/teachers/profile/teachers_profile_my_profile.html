{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>EduLink - Teacher Profile</title>
  <meta name="description" content="Manage your EduLink teacher profile, settings, and activities">
  <meta name="keywords" content="education, profile, teacher, settings">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/aos/aos.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet">

  <!-- CSS Files -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet">
  <link href="{% static 'css/homepage.css' %}" rel="stylesheet">
  <link href="{% static 'css/profile_pages.css' %}" rel="stylesheet">

  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
</head>

<body class="index-page">
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="{% url 'teachers_homepage' %}" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">EduLink</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="{% url 'teachers_homepage' %}">Home</a></li>
          <li><a href="{% url 'teachers_community_page' %}">Community</a></li>
          <li><a href="{% url 'teachers_profile_page' %}" class="active">My Profile</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="container profile-container">
      <!-- Profile Header -->
      <div class="profile-header" data-aos="fade-up">
        <form id="profilePicForm" method="POST" action="{% url 'teachers_profile_update' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="profile-avatar">
            <img src="{{ profile_picture }}" alt="{{ name }}" id="profilePic">
            <div class="profile-avatar-overlay">
              <button type="button" class="avatar-edit-btn" id="changeProfileBtn">
                <i class="bi bi-camera"></i> Change
              </button>
            </div>
            <input type="file" name="profile_picture" id="fileInput" accept="image/*" style="display: none;">
          </div>
        </form>
        
        <h2 class="profile-name">{{ name }}</h2>
        <div class="profile-role">Teacher</div>
        
        <div class="profile-stats">
          <div class="stat-item">
            <div class="stat-value">{{ followers }}</div>
            <div class="stat-label">Followers</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ followings }}</div>
            <div class="stat-label">Following</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ hubs_count }}</div>
            <div class="stat-label">Hubs</div>
          </div>
        </div>
      </div>
      
      <!-- Profile Content -->
      <div class="profile-content" data-aos="fade-up" data-aos-delay="100">
        <!-- Left Navigation -->
        <nav class="profile-nav">
          <ul class="profile-nav-list">
            <li class="profile-nav-item">
              <a href="{% url 'teacher_profile_page_my_profile' %}" class="profile-nav-link {% if request.resolver_match.url_name == 'teacher_profile_page_my_profile' %}active{% endif %}">
                <i class="bi bi-person-workspace profile-nav-icon"></i>
                My Profile
              </a>
            </li>
            <li class="profile-nav-item">
              <a href="{% url 'teacher_profile_page_activity_contribution' %}" class="profile-nav-link {% if request.resolver_match.url_name == 'teacher_profile_page_activity_contribution' %}active{% endif %}">
                <i class="bi bi-bar-chart profile-nav-icon"></i>
                Activity & Analytics
              </a>
            </li>
            <li class="profile-nav-item">
              <a href="{% url 'teacher_profile_page_securty_settings' %}" class="profile-nav-link {% if request.resolver_match.url_name == 'teacher_profile_page_securty_settings' %}active{% endif %}">
                <i class="bi bi-shield-lock profile-nav-icon"></i>
                Security & Settings
              </a>
            </li>
            <li class="profile-nav-item">
              <a href="{% url 'login_page_teachers' %}?role=teacher" class="profile-nav-link">
                <i class="bi bi-box-arrow-right profile-nav-icon"></i>
                Logout
              </a>
            </li>
          </ul>
        </nav>
        
        <!-- Right Detail Area -->
        <div class="profile-detail">
          {% block profile_content %}
          <!-- My Profile Content -->
          <div class="profile-detail-header">
            <h3 class="profile-detail-title">Teacher Profile</h3>
          </div>
          
          <!-- Bio Section -->
          <div class="profile-section">
            <h4 class="section-title">
              <i class="bi bi-person-vcard"></i> Professional Bio
            </h4>
            <form id="bioForm" method="POST" action="{% url 'teachers_profile_update' %}">
              {% csrf_token %}
              <div class="form-row">
                <textarea name="bio" id="bioInput" class="form-control" placeholder="Share your educational background, expertise, and teaching philosophy...">{{ bio }}</textarea>
              </div>
              <div class="form-row">
                <button type="submit" id="submitBioBtn" class="btn btn-primary">
                  <i class="bi bi-check-circle"></i> Save Bio
                </button>
              </div>
            </form>
          </div>
          
          <!-- Websites Section -->
          <div class="profile-section">
            <h4 class="section-title">
              <i class="bi bi-link-45deg"></i> Professional Websites
            </h4>
            <form id="websitesForm" method="POST" action="{% url 'teachers_profile_update' %}">
              {% csrf_token %}
              <div class="website-input-group">
                <input type="text" name="website" id="websiteInput" class="form-control" placeholder="Enter a resource or personal website URL">
                <button type="button" id="addWebsiteBtn" class="btn btn-primary">
                  <i class="bi bi-plus-lg"></i> Add
                </button>
              </div>
            </form>
            
            <ul id="websiteList" class="website-list">
              {% for website in websites %}
                <li class="website-item">
                  <a href="{{ website }}" target="_blank">{{ website }}</a>
                  <button type="button" class="btn-remove" data-website="{{ website }}">
                    <i class="bi bi-x-circle"></i>
                  </button>
                </li>
              {% empty %}
                <li class="website-item" id="no-websites">No websites added yet.</li>
              {% endfor %}
            </ul>
          </div>
          
          <!-- Teaching Stats Section -->
          <div class="profile-section">
            <h4 class="section-title">
              <i class="bi bi-mortarboard"></i> Teaching Statistics
            </h4>
            
            <div class="row">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-card-icon">
                    <i class="bi bi-people-fill"></i>
                  </div>
                  <div class="stat-card-content">
                    <div class="stat-card-value">{{ students_count|default:"0" }}</div>
                    <div class="stat-card-label">Active Students</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-card-icon">
                    <i class="bi bi-chat-square-text"></i>
                  </div>
                  <div class="stat-card-content">
                    <div class="stat-card-value">{{ messages_count|default:"0" }}</div>
                    <div class="stat-card-label">Messages</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-card-icon">
                    <i class="bi bi-award"></i>
                  </div>
                  <div class="stat-card-content">
                    <div class="stat-card-value">{{ created_at_year }}</div>
                    <div class="stat-card-label">Years Teaching</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Account Information -->
          <div class="profile-section">
            <h4 class="section-title">
              <i class="bi bi-info-circle"></i> Account Information
            </h4>
            <div class="account-info">
              <i class="bi bi-calendar-check account-info-icon"></i>
              <div>
                <div>Member since</div>
                <div class="account-info-date">{{ created_at }}</div>
              </div>
            </div>
          </div>
          {% endblock %}
        </div>
      </div>
    </section>
  </main>

  <!-- Vendor JS Files -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/aos/aos.js' %}"></script>
  <script src="{% static 'vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'vendor/swiper/swiper-bundle.min.js' %}"></script>

  <!-- Main JS File -->
  <script src="{% static 'js/main.js' %}"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize AOS animations
      AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true,
        mirror: false
      });
      
      // Handle profile picture upload
      const changeProfileBtn = document.getElementById('changeProfileBtn');
      const fileInput = document.getElementById('fileInput');

      if (changeProfileBtn && fileInput) {
        changeProfileBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;

          // Preview image
          const reader = new FileReader();
          reader.onload = (e) => document.getElementById('profilePic').src = e.target.result;
          reader.readAsDataURL(file);

          // Send to backend
          const formData = new FormData();
          formData.append('profile_picture', file);
          formData.append('type', 'profile_pic');
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          fetch("{% url 'teachers_profile_update' %}", {
            method: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification('Profile picture updated successfully!', 'success');
            } else {
              showNotification(data.error || 'Error updating profile picture', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
          });
        });
      }
      
      // Handle website additions
      const addWebsiteBtn = document.getElementById('addWebsiteBtn');
      const websiteInput = document.getElementById('websiteInput');
      const websiteList = document.getElementById('websiteList');
      const noWebsitesElement = document.getElementById('no-websites');
      
      if (addWebsiteBtn && websiteInput && websiteList) {
        addWebsiteBtn.addEventListener('click', function() {
          const websiteUrl = websiteInput.value.trim();
          if (!websiteUrl) return;
          
          // Send to backend
          const formData = new FormData();
          formData.append('website', websiteUrl);
          formData.append('type', 'website');
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          
          fetch("{% url 'teachers_profile_update' %}", {
            method: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Remove "no websites" message if present
              if (noWebsitesElement) {
                noWebsitesElement.remove();
              }
              
              // Create and add website item
              const li = document.createElement('li');
              li.className = 'website-item';
              li.innerHTML = `
                <a href="${websiteUrl}" target="_blank">${websiteUrl}</a>
                <button type="button" class="btn-remove" data-website="${websiteUrl}">
                  <i class="bi bi-x-circle"></i>
                </button>
              `;
              websiteList.appendChild(li);
              
              // Clear input
              websiteInput.value = '';
              
              showNotification('Website added successfully!', 'success');
            } else {
              showNotification(data.error || 'Error adding website', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
          });
        });
      }
      
      // Handle bio update
      const bioForm = document.getElementById('bioForm');
      if (bioForm) {
        bioForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const bioInput = document.getElementById('bioInput');
          const bioText = bioInput.value.trim();
          
          // Send to backend
          const formData = new FormData();
          formData.append('bio', bioText);
          formData.append('type', 'bio');
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          
          fetch("{% url 'teachers_profile_update' %}", {
            method: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification('Bio updated successfully!', 'success');
            } else {
              showNotification(data.error || 'Error updating bio', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
          });
        });
      }
      
      // Function to show notifications
      function showNotification(message, type) {
        // Check if a notification container exists
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
          // Create notification container
          notificationContainer = document.createElement('div');
          notificationContainer.id = 'notification-container';
          notificationContainer.style.position = 'fixed';
          notificationContainer.style.top = '80px';
          notificationContainer.style.right = '20px';
          notificationContainer.style.zIndex = '9999';
          document.body.appendChild(notificationContainer);
        }
        
        // Create notification
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
        notification.style.color = 'white';
        notification.style.padding = '12px 20px';
        notification.style.marginBottom = '10px';
        notification.style.borderRadius = '4px';
        notification.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(50px)';
        notification.style.transition = 'opacity 0.3s, transform 0.3s';
        
        // Add icon based on type
        const icon = document.createElement('i');
        icon.className = type === 'success' ? 'bi bi-check-circle-fill' : 'bi bi-x-circle-fill';
        icon.style.marginRight = '10px';
        
        notification.appendChild(icon);
        notification.appendChild(document.createTextNode(message));
        
        // Add notification to container
        notificationContainer.appendChild(notification);
        
        // Trigger animation
        setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(50px)';
          
          // Remove from DOM after animation completes
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 5000);
      }
    });
  </script>
  
  <style>
    /* Teaching Statistics Cards */
    .stat-card {
      display: flex;
      align-items: center;
      background-color: var(--light-gray);
      border-radius: var(--border-radius-sm);
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all var(--transition-normal);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-sm);
    }
    
    .stat-card-icon {
      width: 50px;
      height: 50px;
      min-width: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      color: var(--white);
      font-size: 1.5rem;
    }
    
    .stat-card-content {
      flex: 1;
    }
    
    .stat-card-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark-gray);
    }
    
    .stat-card-label {
      font-size: 0.85rem;
      color: var(--dark-gray);
      opacity: 0.7;
    }
  </style>
</body>
</html>